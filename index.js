"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CreateInstance = exports.BodyParserMiddleware = exports.BaseMiddleware = void 0;

require("source-map-support/register");

const SYMBOL_ERR_TYPE = Symbol("SYMBOL_BEFOREHOOK_ERR_TYPE");
const SYMBOL_SHORT_CIRCUIT_TYPE = Symbol("SYMBOL_BEFOREHOOK_SHORT_CIRCUIT_TYPE");
const SYMBOL_MIDDLEWARE_ON_CATCH = Symbol("SYMBOL_BEFOREHOOK_MIDDLEWARE_ON_CATCH");
const SYMBOL_MIDDLEWARE_ID = Symbol("SYMBOL_BEFOREHOOK_MIDDLEWARE_ID");

const isError = e => {
  return e && e.stack && e.message;
};

const objectAssignIfExists = (...args) => {
  const def = { ...args[1]
  };
  const overrideIfExist = { ...args[2]
  };
  Object.keys(def).forEach(k => {
    if (overrideIfExist[k]) {
      def[k] = overrideIfExist[k];
    }
  });
  return { ...args[0],
    ...def
  };
};

const MiddlewareHelpersInit = () => {
  const pvtLogger = {
    /* eslint-disable-next-line no-console */
    log: (...args) => args.forEach(l => console.log(l.message || l)),

    /* eslint-disable-next-line no-console */
    logError: (...args) => args.forEach(l => console.error(l.message || l))
  };

  const reply = obj => {
    // TODO: this is redundunt to another declaration of reply

    /* eslint-disable-next-line no-param-reassign */
    const customError = Error(JSON.stringify(obj));
    customError[SYMBOL_ERR_TYPE] = true;
    customError[SYMBOL_SHORT_CIRCUIT_TYPE] = "reply";
    throw customError;
  };

  return () => ({
    reply,
    getLogger: () => pvtLogger
  });
};
/* deprecated const setState = (objs, oldState, state) => {
  const mutatedOldState = oldState;
  const newState = state;

  Object.keys(objs).forEach(key => {
    newState[key] = objs[key];
    mutatedOldState[key] = objs[key];
  });

  return mutatedOldState;
};
const setContext = setState; */

/* deprecated const simpleClone = objectToClone =>
  /* JSON.parse(JSON.stringify( * / objectToClone; /* )) * /
const clone = simpleClone; */


const BaseMiddlewareHandlerInit = handler => {
  const dispatchFn = async (...args) => {
    try {
      await handler({
        getParams: () => args,
        reply: obj => {
          /* eslint-disable-next-line no-param-reassign */
          const shortCircuitErrorObject = Error(JSON.stringify(obj));
          shortCircuitErrorObject[SYMBOL_ERR_TYPE] = true;
          shortCircuitErrorObject[SYMBOL_SHORT_CIRCUIT_TYPE] = "reply";
          throw shortCircuitErrorObject;
        },
        next: () => {
          const shortCircuitErrorObject = Error("next is called.");
          shortCircuitErrorObject[SYMBOL_SHORT_CIRCUIT_TYPE] = "next";
        },
        getHelpers: MiddlewareHelpersInit()
      }, {});
    } catch (error) {
      /* ignore, next() is called */
      if (error[SYMBOL_SHORT_CIRCUIT_TYPE] === "next") {
        return args;
      }

      throw error;
    }

    return args;
  };

  return dispatchFn;
};

const BaseMiddleware = ({
  handler,
  configure
} = {}) => {
  if (!(typeof handler === "function")) {
    throw Error(`Custom middlewares must define a "handler"`);
  }

  let pre = async () => {};

  pre = BaseMiddlewareHandlerInit(handler);
  pre[SYMBOL_MIDDLEWARE_ID] = true;

  if (configure && configure.augmentMethods) {
    const {
      augmentMethods = {}
    } = configure;
    const configurableMethods = ["onCatch"];
    configurableMethods.forEach(fnName => {
      const newMethod = augmentMethods[fnName];

      if (typeof newMethod === "function") {
        if (fnName === "onCatch") {
          pre[SYMBOL_MIDDLEWARE_ON_CATCH] = (oldMethod, e) => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        }
      }
    });
  }

  return pre;
};

exports.BaseMiddleware = BaseMiddleware;

const BodyParserMiddleware = () => {
  return BaseMiddleware({
    handler: async ({
      getParams
    }) => {
      const [event] = getParams();

      if (Object.keys({ ...event.body
      }).length) {
        event.body = JSON.parse(event.body);
      }
    }
  });
};

exports.BodyParserMiddleware = BodyParserMiddleware;

const CreateInstance = options => {
  let settings = {
    DEBUG: false,
    stopOnCatch: true
  };
  settings = objectAssignIfExists({}, settings, options);
  let pvtDispatched = false;
  const stackedHooks = [];
  let isHandlerFed = false;
  let handlerLength = -1;

  let handler = async () => {};

  let FODispatch = async () => {};
  /*
   *
   * CONFIGURABLES - START
   *
   */


  let pvtLogger = {
    /* eslint-disable-next-line no-console */
    log: (...args) => args.forEach(l => console.log(l.message || l)),

    /* eslint-disable-next-line no-console */
    logError: (...args) => args.forEach(l => console.error(l.message || l)),
    logWarning: (...args) =>
    /* eslint-disable-next-line no-console */
    args.forEach(l => console.error(`WARNING: ${l.message || l}`))
  };
  /* logs are off by default */

  if (settings.DEBUG !== true) {
    pvtLogger.log = () => {};

    pvtLogger.logError = () => {};

    pvtLogger.logWarning = () => {};
  }

  let onReturnObject = args => args;

  const onReply = (...args) => onReturnObject(...args);

  let onCatch = (...args) => {
    const [e] = args;

    if (!isError(e)) {
      pvtLogger.logError(`Short circuit handler onCatch is expecting an Error but got ${e.toString && e.toString()}`); // TODO: expose "reply" instead and not prevMethod...

      if (typeof e === "object" && e.statusCode >= 400) {
        return onReturnObject(e);
      }
    }

    try {
      if (e[SYMBOL_ERR_TYPE] === true) {
        // if (e[SYMBOL_SHORT_CIRCUIT_TYPE] === "reply") {
        //   return onReply(JSON.parse(e.message));
        // }
        return onReturnObject(JSON.parse(e.message));
      }

      pvtLogger.logError(e);
      return onReturnObject({
        statusCode: 500,
        body: `${e.message}`
      });
    } catch (parseError) {
      pvtLogger.logError(parseError);
      return onReturnObject({
        statusCode: 500,
        body: `${parseError.message} - ${e && e.message ? e.message : ""}`
      });
    }
  };

  let handlerCallWrapper = (...args) => {
    return handler(...args);
  };
  /**
   *
   * CONFIGURABLES - END
   *
   * */


  const configure = ({
    augmentMethods = {}
  } = {}) => {
    const configurableMethods = ["onCatch", "onReturnObject", "handlerCallWrapper", "pvtLogger"];
    configurableMethods.forEach(fnName => {
      const newMethod = augmentMethods[fnName];

      if (typeof newMethod === "function") {
        if (fnName === "onReturnObject") {
          const oldMethod = onReturnObject;

          onReturnObject = (arg1, params) => {
            return newMethod(() => oldMethod(arg1), {
              prevRawMethod: oldMethod,
              arg: arg1,
              ...params
            });
          };
        } else if (fnName === "onCatch") {
          const oldMethod = onCatch;

          onCatch = (arg1, params) => {
            return newMethod(() => oldMethod(arg1), {
              prevRawMethod: oldMethod,
              arg: arg1,
              ...params
            });
          };
        } else if (fnName === "handlerCallWrapper") {
          const oldMethod = handlerCallWrapper;

          handlerCallWrapper = e => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        } else if (fnName === "pvtLogger") {
          const oldMethod = pvtLogger;

          pvtLogger = e => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        }
      }
    });
  };
  /* init configurables */


  if (options && options.configure) {
    configure(options.configure);
  }
  /**
   *
   * CORE - START
   *
   * */

  /* Function Object Init "Before Hook" */


  const FOInitBeforeHook = (...args) => {
    if (isHandlerFed === true) {
      handlerLength = handler.length;
    }

    if (typeof args[0] === "undefined") {
      pvtLogger.logWarning(`"undefined" is probably not expected here.`);
    }

    if (isHandlerFed === false && Array.isArray(args[0])) {
      if (args[0].every(fn => typeof fn === "function")) {
        const FOArray = args[0].map(item => CreateInstance(options)(item));

        FOArray.use = (...useArgs) => {
          const FOArrayInner = FOArray.map(instance => instance.use(...useArgs));
          FOArrayInner.use = FOArray.use;
          return FOArrayInner;
        };

        return FOArray;
      }

      throw Error("before-hook can only be used for functions. One of the item in arrays is not.");
    } else if (typeof args[0] !== "function") {
      if (handlerLength > -1 && handlerLength !== args.length) {
        pvtLogger.logWarning(`Dispatching with ${args.length} args while the original handler has ${handlerLength}.`);
      }

      return FODispatch(...args);
    }

    if (isHandlerFed === true && args[0][SYMBOL_MIDDLEWARE_ID] !== true) {
      /* then we assume this scenario calls for a new instance */
      return CreateInstance(options)(args[0]);
    }

    [handler] = args;
    isHandlerFed = true;
    return FODispatch;
  };

  FOInitBeforeHook.use = (...args) => {
    if (!args || !args[0]) {
      throw Error(`.use expects an instance from BaseMiddleware. (Got type "${typeof args[0]}")`);
    }

    if (isHandlerFed === false) {
      throw Error("A handler needs to be fed first before calling .use");
    }

    if (args.length > 1) {
      pvtLogger.logWarning(`Ignoring 2nd argument. "use" method was called with more than 1 argument.`);
    }

    if (pvtDispatched === true) {
      throw Error("Using middlewares again after handler's invocation is not allowed.");
    }

    const middleware = args[0];

    if (middleware[SYMBOL_MIDDLEWARE_ID] === true) {
      stackedHooks.push(middleware);
    } else {
      throw Error("Unknown middleware. Middlewares must extend BaseMiddleware.");
    }

    return FOInitBeforeHook;
  };

  FOInitBeforeHook.setLogger = newLogger => {
    pvtLogger = newLogger;
  };

  FOInitBeforeHook.getLogger = () => pvtLogger;

  FODispatch = async (...args) => {
    let hookBeforeCatching = {};
    pvtDispatched = true;

    try {
      /* eslint-disable-next-line no-restricted-syntax */
      for (const hook of stackedHooks) {
        hookBeforeCatching = hook;
        /* eslint-disable-next-line no-await-in-loop */

        await hook(...args); // const extensions = await hook(...args);
      }
    } catch (middlewaresThrow) {
      if (middlewaresThrow[SYMBOL_SHORT_CIRCUIT_TYPE] === "reply") {
        if (settings.stopOnCatch === true) {
          return onReply(JSON.parse(middlewaresThrow.message));
        }
      }

      const catchHandlerToUse = typeof hookBeforeCatching[SYMBOL_MIDDLEWARE_ON_CATCH] === "function" ? (err, params) => hookBeforeCatching[SYMBOL_MIDDLEWARE_ON_CATCH](e => onCatch(e, params), err) : (err, params) => onCatch(err, params);

      if (settings.stopOnCatch === true) {
        return catchHandlerToUse(middlewaresThrow, {
          getParams: () => args
        });
      }

      catchHandlerToUse(middlewaresThrow, {
        getParams: () => args
      });
    }

    return handlerCallWrapper(...args);
  };
  /* copy properties of FOInitBeforeHook to FODispatch - so we can chain .use and etc */


  Object.keys(FOInitBeforeHook).forEach(method => {
    FODispatch[method] = FOInitBeforeHook[method];
  });
  /**
   *
   * CORE - END
   *
   * */

  return FOInitBeforeHook;
};

exports.CreateInstance = CreateInstance;
var _default = CreateInstance;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnNvdXJjZS5qcyJdLCJuYW1lcyI6WyJTWU1CT0xfRVJSX1RZUEUiLCJTeW1ib2wiLCJTWU1CT0xfU0hPUlRfQ0lSQ1VJVF9UWVBFIiwiU1lNQk9MX01JRERMRVdBUkVfT05fQ0FUQ0giLCJTWU1CT0xfTUlERExFV0FSRV9JRCIsImlzRXJyb3IiLCJlIiwic3RhY2siLCJtZXNzYWdlIiwib2JqZWN0QXNzaWduSWZFeGlzdHMiLCJhcmdzIiwiZGVmIiwib3ZlcnJpZGVJZkV4aXN0IiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrIiwiTWlkZGxld2FyZUhlbHBlcnNJbml0IiwicHZ0TG9nZ2VyIiwibG9nIiwibCIsImNvbnNvbGUiLCJsb2dFcnJvciIsImVycm9yIiwicmVwbHkiLCJvYmoiLCJjdXN0b21FcnJvciIsIkVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsImdldExvZ2dlciIsIkJhc2VNaWRkbGV3YXJlSGFuZGxlckluaXQiLCJoYW5kbGVyIiwiZGlzcGF0Y2hGbiIsImdldFBhcmFtcyIsInNob3J0Q2lyY3VpdEVycm9yT2JqZWN0IiwibmV4dCIsImdldEhlbHBlcnMiLCJCYXNlTWlkZGxld2FyZSIsImNvbmZpZ3VyZSIsInByZSIsImF1Z21lbnRNZXRob2RzIiwiY29uZmlndXJhYmxlTWV0aG9kcyIsImZuTmFtZSIsIm5ld01ldGhvZCIsIm9sZE1ldGhvZCIsInByZXZSYXdNZXRob2QiLCJhcmciLCJCb2R5UGFyc2VyTWlkZGxld2FyZSIsImV2ZW50IiwiYm9keSIsImxlbmd0aCIsInBhcnNlIiwiQ3JlYXRlSW5zdGFuY2UiLCJvcHRpb25zIiwic2V0dGluZ3MiLCJERUJVRyIsInN0b3BPbkNhdGNoIiwicHZ0RGlzcGF0Y2hlZCIsInN0YWNrZWRIb29rcyIsImlzSGFuZGxlckZlZCIsImhhbmRsZXJMZW5ndGgiLCJGT0Rpc3BhdGNoIiwibG9nV2FybmluZyIsIm9uUmV0dXJuT2JqZWN0Iiwib25SZXBseSIsIm9uQ2F0Y2giLCJ0b1N0cmluZyIsInN0YXR1c0NvZGUiLCJwYXJzZUVycm9yIiwiaGFuZGxlckNhbGxXcmFwcGVyIiwiYXJnMSIsInBhcmFtcyIsIkZPSW5pdEJlZm9yZUhvb2siLCJBcnJheSIsImlzQXJyYXkiLCJldmVyeSIsImZuIiwiRk9BcnJheSIsIm1hcCIsIml0ZW0iLCJ1c2UiLCJ1c2VBcmdzIiwiRk9BcnJheUlubmVyIiwiaW5zdGFuY2UiLCJtaWRkbGV3YXJlIiwicHVzaCIsInNldExvZ2dlciIsIm5ld0xvZ2dlciIsImhvb2tCZWZvcmVDYXRjaGluZyIsImhvb2siLCJtaWRkbGV3YXJlc1Rocm93IiwiY2F0Y2hIYW5kbGVyVG9Vc2UiLCJlcnIiLCJtZXRob2QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE1BQU1BLGVBQWUsR0FBR0MsTUFBTSxDQUFDLDRCQUFELENBQTlCO0FBQ0EsTUFBTUMseUJBQXlCLEdBQUdELE1BQU0sQ0FDdEMsc0NBRHNDLENBQXhDO0FBR0EsTUFBTUUsMEJBQTBCLEdBQUdGLE1BQU0sQ0FDdkMsdUNBRHVDLENBQXpDO0FBR0EsTUFBTUcsb0JBQW9CLEdBQUdILE1BQU0sQ0FBQyxpQ0FBRCxDQUFuQzs7QUFFQSxNQUFNSSxPQUFPLEdBQUdDLENBQUMsSUFBSTtBQUNuQixTQUFPQSxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsS0FBUCxJQUFnQkQsQ0FBQyxDQUFDRSxPQUF6QjtBQUNELENBRkQ7O0FBSUEsTUFBTUMsb0JBQW9CLEdBQUcsQ0FBQyxHQUFHQyxJQUFKLEtBQWE7QUFDeEMsUUFBTUMsR0FBRyxHQUFHLEVBQUUsR0FBR0QsSUFBSSxDQUFDLENBQUQ7QUFBVCxHQUFaO0FBQ0EsUUFBTUUsZUFBZSxHQUFHLEVBQUUsR0FBR0YsSUFBSSxDQUFDLENBQUQ7QUFBVCxHQUF4QjtBQUNBRyxFQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWUgsR0FBWixFQUFpQkksT0FBakIsQ0FBeUJDLENBQUMsSUFBSTtBQUM1QixRQUFJSixlQUFlLENBQUNJLENBQUQsQ0FBbkIsRUFBd0I7QUFDdEJM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TUFBRCxDQUFWLEdBQXFCckIsZ0JBQWdCLENBQUNxQixNQUFELENBQXJDO0FBQ0QsR0FGRDtBQUlBOzs7Ozs7QUFNQSxTQUFPckIsZ0JBQVA7QUFDRCxDQXhTRDs7O2VBNFNlcEIsYyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFNZTUJPTF9FUlJfVFlQRSA9IFN5bWJvbChcIlNZTUJPTF9CRUZPUkVIT09LX0VSUl9UWVBFXCIpO1xuY29uc3QgU1lNQk9MX1NIT1JUX0NJUkNVSVRfVFlQRSA9IFN5bWJvbChcbiAgXCJTWU1CT0xfQkVGT1JFSE9PS19TSE9SVF9DSVJDVUlUX1RZUEVcIlxuKTtcbmNvbnN0IFNZTUJPTF9NSURETEVXQVJFX09OX0NBVENIID0gU3ltYm9sKFxuICBcIlNZTUJPTF9CRUZPUkVIT09LX01JRERMRVdBUkVfT05fQ0FUQ0hcIlxuKTtcbmNvbnN0IFNZTUJPTF9NSURETEVXQVJFX0lEID0gU3ltYm9sKFwiU1lNQk9MX0JFRk9SRUhPT0tfTUlERExFV0FSRV9JRFwiKTtcblxuY29uc3QgaXNFcnJvciA9IGUgPT4ge1xuICByZXR1cm4gZSAmJiBlLnN0YWNrICYmIGUubWVzc2FnZTtcbn07XG5cbmNvbnN0IG9iamVjdEFzc2lnbklmRXhpc3RzID0gKC4uLmFyZ3MpID0+IHtcbiAgY29uc3QgZGVmID0geyAuLi5hcmdzWzFdIH07XG4gIGNvbnN0IG92ZXJyaWRlSWZFeGlzdCA9IHsgLi4uYXJnc1syXSB9O1xuICBPYmplY3Qua2V5cyhkZWYpLmZvckVhY2goayA9PiB7XG4gICAgaWYgKG92ZXJyaWRlSWZFeGlzdFtrXSkge1xuICAgICAgZGVmW2tdID0gb3ZlcnJpZGVJZkV4aXN0W2tdO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHsgLi4uYXJnc1swXSwgLi4uZGVmIH07XG59O1xuXG5jb25zdCBNaWRkbGV3YXJlSGVscGVyc0luaXQgPSAoKSA9PiB7XG4gIGNvbnN0IHB2dExvZ2dlciA9IHtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZzogKC4uLmFyZ3MpID0+IGFyZ3MuZm9yRWFjaChsID0+IGNvbnNvbGUubG9nKGwubWVzc2FnZSB8fCBsKSksXG5cbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZ0Vycm9yOiAoLi4uYXJncykgPT4gYXJncy5mb3JFYWNoKGwgPT4gY29uc29sZS5lcnJvcihsLm1lc3NhZ2UgfHwgbCkpXG4gIH07XG5cbiAgY29uc3QgcmVwbHkgPSBvYmogPT4ge1xuICAgIC8vIFRPRE86IHRoaXMgaXMgcmVkdW5kdW50IHRvIGFub3RoZXIgZGVjbGFyYXRpb24gb2YgcmVwbHlcblxuICAgIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuICAgIGNvbnN0IGN1c3RvbUVycm9yID0gRXJyb3IoSlNPTi5zdHJpbmdpZnkob2JqKSk7XG4gICAgY3VzdG9tRXJyb3JbU1lNQk9MX0VSUl9UWVBFXSA9IHRydWU7XG4gICAgY3VzdG9tRXJyb3JbU1lNQk9MX1NIT1JUX0NJUkNVSVRfVFlQRV0gPSBcInJlcGx5XCI7XG5cbiAgICB0aHJvdyBjdXN0b21FcnJvcjtcbiAgfTtcblxuICByZXR1cm4gKCkgPT4gKHtcbiAgICByZXBseSxcbiAgICBnZXRMb2dnZXI6ICgpID0+IHB2dExvZ2dlclxuICB9KTtcbn07XG5cbi8qIGRlcHJlY2F0ZWQgY29uc3Qgc2V0U3RhdGUgPSAob2Jqcywgb2xkU3RhdGUsIHN0YXRlKSA9PiB7XG4gIGNvbnN0IG11dGF0ZWRPbGRTdGF0ZSA9IG9sZFN0YXRlO1xuICBjb25zdCBuZXdTdGF0ZSA9IHN0YXRlO1xuXG4gIE9iamVjdC5rZXlzKG9ianMpLmZvckVhY2goa2V5ID0+IHtcbiAgICBuZXdTdGF0ZVtrZXldID0gb2Jqc1trZXldO1xuICAgIG11dGF0ZWRPbGRTdGF0ZVtrZXldID0gb2Jqc1trZXldO1xuICB9KTtcblxuICByZXR1cm4gbXV0YXRlZE9sZFN0YXRlO1xufTtcbmNvbnN0IHNldENvbnRleHQgPSBzZXRTdGF0ZTsgKi9cbi8qIGRlcHJlY2F0ZWQgY29uc3Qgc2ltcGxlQ2xvbmUgPSBvYmplY3RUb0Nsb25lID0+XG4gIC8qIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoICogLyBvYmplY3RUb0Nsb25lOyAvKiApKSAqIC9cbmNvbnN0IGNsb25lID0gc2ltcGxlQ2xvbmU7ICovXG5cbmNvbnN0IEJhc2VNaWRkbGV3YXJlSGFuZGxlckluaXQgPSBoYW5kbGVyID0+IHtcbiAgY29uc3QgZGlzcGF0Y2hGbiA9IGFzeW5jICguLi5hcmdzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGhhbmRsZXIoXG4gICAgICAgIHtcbiAgICAgICAgICBnZXRQYXJhbXM6ICgpID0+IGFyZ3MsXG4gICAgICAgICAgcmVwbHk6IG9iaiA9PiB7XG4gICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cbiAgICAgICAgICAgIGNvbnN0IHNob3J0Q2lyY3VpdEVycm9yT2JqZWN0ID0gRXJyb3IoSlNPTi5zdHJpbmdpZnkob2JqKSk7XG4gICAgICAgICAgICBzaG9ydENpcmN1aXRFcnJvck9iamVjdFtTWU1CT0xfRVJSX1RZUEVdID0gdHJ1ZTtcbiAgICAgICAgICAgIHNob3J0Q2lyY3VpdEVycm9yT2JqZWN0W1NZTUJPTF9TSE9SVF9DSVJDVUlUX1RZUEVdID0gXCJyZXBseVwiO1xuXG4gICAgICAgICAgICB0aHJvdyBzaG9ydENpcmN1aXRFcnJvck9iamVjdDtcbiAgICAgICAgICB9LFxuICAgICAgICAgIG5leHQ6ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNob3J0Q2lyY3VpdEVycm9yT2JqZWN0ID0gRXJyb3IoXCJuZXh0IGlzIGNhbGxlZC5cIik7XG4gICAgICAgICAgICBzaG9ydENpcmN1aXRFcnJvck9iamVjdFtTWU1CT0xfU0hPUlRfQ0lSQ1VJVF9UWVBFXSA9IFwibmV4dFwiO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZ2V0SGVscGVyczogTWlkZGxld2FyZUhlbHBlcnNJbml0KClcbiAgICAgICAgfSxcbiAgICAgICAge31cbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8qIGlnbm9yZSwgbmV4dCgpIGlzIGNhbGxlZCAqL1xuICAgICAgaWYgKGVycm9yW1NZTUJPTF9TSE9SVF9DSVJDVUlUX1RZUEVdID09PSBcIm5leHRcIikge1xuICAgICAgICByZXR1cm4gYXJncztcbiAgICAgIH1cblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFyZ3M7XG4gIH07XG5cbiAgcmV0dXJuIGRpc3BhdGNoRm47XG59O1xuXG5jb25zdCBCYXNlTWlkZGxld2FyZSA9ICh7IGhhbmRsZXIsIGNvbmZpZ3VyZSB9ID0ge30pID0+IHtcbiAgaWYgKCEodHlwZW9mIGhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikpIHtcbiAgICB0aHJvdyBFcnJvcihgQ3VzdG9tIG1pZGRsZXdhcmVzIG11c3QgZGVmaW5lIGEgXCJoYW5kbGVyXCJgKTtcbiAgfVxuXG4gIGxldCBwcmUgPSBhc3luYyAoKSA9PiB7fTtcbiAgcHJlID0gQmFzZU1pZGRsZXdhcmVIYW5kbGVySW5pdChoYW5kbGVyKTtcblxuICBwcmVbU1lNQk9MX01JRERMRVdBUkVfSURdID0gdHJ1ZTtcblxuICBpZiAoY29uZmlndXJlICYmIGNvbmZpZ3VyZS5hdWdtZW50TWV0aG9kcykge1xuICAgIGNvbnN0IHsgYXVnbWVudE1ldGhvZHMgPSB7fSB9ID0gY29uZmlndXJlO1xuICAgIGNvbnN0IGNvbmZpZ3VyYWJsZU1ldGhvZHMgPSBbXCJvbkNhdGNoXCJdO1xuXG4gICAgY29uZmlndXJhYmxlTWV0aG9kcy5mb3JFYWNoKGZuTmFtZSA9PiB7XG4gICAgICBjb25zdCBuZXdNZXRob2QgPSBhdWdtZW50TWV0aG9kc1tmbk5hbWVdO1xuXG4gICAgICBpZiAodHlwZW9mIG5ld01ldGhvZCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGlmIChmbk5hbWUgPT09IFwib25DYXRjaFwiKSB7XG4gICAgICAgICAgcHJlW1NZTUJPTF9NSURETEVXQVJFX09OX0NBVENIXSA9IChvbGRNZXRob2QsIGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGUpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcHJlO1xufTtcblxuY29uc3QgQm9keVBhcnNlck1pZGRsZXdhcmUgPSAoKSA9PiB7XG4gIHJldHVybiBCYXNlTWlkZGxld2FyZSh7XG4gICAgaGFuZGxlcjogYXN5bmMgKHsgZ2V0UGFyYW1zIH0pID0+IHtcbiAgICAgIGNvbnN0IFtldmVudF0gPSBnZXRQYXJhbXMoKTtcbiAgICAgIGlmIChPYmplY3Qua2V5cyh7IC4uLmV2ZW50LmJvZHkgfSkubGVuZ3RoKSB7XG4gICAgICAgIGV2ZW50LmJvZHkgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59O1xuXG5jb25zdCBDcmVhdGVJbnN0YW5jZSA9IG9wdGlvbnMgPT4ge1xuICBsZXQgc2V0dGluZ3MgPSB7XG4gICAgREVCVUc6IGZhbHNlLFxuICAgIHN0b3BPbkNhdGNoOiB0cnVlXG4gIH07XG5cbiAgc2V0dGluZ3MgPSBvYmplY3RBc3NpZ25JZkV4aXN0cyh7fSwgc2V0dGluZ3MsIG9wdGlvbnMpO1xuXG4gIGxldCBwdnREaXNwYXRjaGVkID0gZmFsc2U7XG4gIGNvbnN0IHN0YWNrZWRIb29rcyA9IFtdO1xuICBsZXQgaXNIYW5kbGVyRmVkID0gZmFsc2U7XG4gIGxldCBoYW5kbGVyTGVuZ3RoID0gLTE7XG5cbiAgbGV0IGhhbmRsZXIgPSBhc3luYyAoKSA9PiB7fTtcbiAgbGV0IEZPRGlzcGF0Y2ggPSBhc3luYyAoKSA9PiB7fTtcblxuICAvKlxuICAgKlxuICAgKiBDT05GSUdVUkFCTEVTIC0gU1RBUlRcbiAgICpcbiAgICovXG5cbiAgbGV0IHB2dExvZ2dlciA9IHtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZzogKC4uLmFyZ3MpID0+IGFyZ3MuZm9yRWFjaChsID0+IGNvbnNvbGUubG9nKGwubWVzc2FnZSB8fCBsKSksXG5cbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZ0Vycm9yOiAoLi4uYXJncykgPT4gYXJncy5mb3JFYWNoKGwgPT4gY29uc29sZS5lcnJvcihsLm1lc3NhZ2UgfHwgbCkpLFxuXG4gICAgbG9nV2FybmluZzogKC4uLmFyZ3MpID0+XG4gICAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgICAgYXJncy5mb3JFYWNoKGwgPT4gY29uc29sZS5lcnJvcihgV0FSTklORzogJHtsLm1lc3NhZ2UgfHwgbH1gKSlcbiAgfTtcblxuICAvKiBsb2dzIGFyZSBvZmYgYnkgZGVmYXVsdCAqL1xuICBpZiAoc2V0dGluZ3MuREVCVUcgIT09IHRydWUpIHtcbiAgICBwdnRMb2dnZXIubG9nID0gKCkgPT4ge307XG4gICAgcHZ0TG9nZ2VyLmxvZ0Vycm9yID0gKCkgPT4ge307XG4gICAgcHZ0TG9nZ2VyLmxvZ1dhcm5pbmcgPSAoKSA9PiB7fTtcbiAgfVxuXG4gIGxldCBvblJldHVybk9iamVjdCA9IGFyZ3MgPT4gYXJncztcbiAgY29uc3Qgb25SZXBseSA9ICguLi5hcmdzKSA9PiBvblJldHVybk9iamVjdCguLi5hcmdzKTtcblxuICBsZXQgb25DYXRjaCA9ICguLi5hcmdzKSA9PiB7XG4gICAgY29uc3QgW2VdID0gYXJncztcblxuICAgIGlmICghaXNFcnJvcihlKSkge1xuICAgICAgcHZ0TG9nZ2VyLmxvZ0Vycm9yKFxuICAgICAgICBgU2hvcnQgY2lyY3VpdCBoYW5kbGVyIG9uQ2F0Y2ggaXMgZXhwZWN0aW5nIGFuIEVycm9yIGJ1dCBnb3QgJHtlLnRvU3RyaW5nICYmXG4gICAgICAgICAgZS50b1N0cmluZygpfWBcbiAgICAgICk7XG5cbiAgICAgIC8vIFRPRE86IGV4cG9zZSBcInJlcGx5XCIgaW5zdGVhZCBhbmQgbm90IHByZXZNZXRob2QuLi5cbiAgICAgIGlmICh0eXBlb2YgZSA9PT0gXCJvYmplY3RcIiAmJiBlLnN0YXR1c0NvZGUgPj0gNDAwKSB7XG4gICAgICAgIHJldHVybiBvblJldHVybk9iamVjdChlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgaWYgKGVbU1lNQk9MX0VSUl9UWVBFXSA9PT0gdHJ1ZSkge1xuICAgICAgICAvLyBpZiAoZVtTWU1CT0xfU0hPUlRfQ0lSQ1VJVF9UWVBFXSA9PT0gXCJyZXBseVwiKSB7XG4gICAgICAgIC8vICAgcmV0dXJuIG9uUmVwbHkoSlNPTi5wYXJzZShlLm1lc3NhZ2UpKTtcbiAgICAgICAgLy8gfVxuICAgICAgICByZXR1cm4gb25SZXR1cm5PYmplY3QoSlNPTi5wYXJzZShlLm1lc3NhZ2UpKTtcbiAgICAgIH1cblxuICAgICAgcHZ0TG9nZ2VyLmxvZ0Vycm9yKGUpO1xuXG4gICAgICByZXR1cm4gb25SZXR1cm5PYmplY3Qoe1xuICAgICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICAgIGJvZHk6IGAke2UubWVzc2FnZX1gXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChwYXJzZUVycm9yKSB7XG4gICAgICBwdnRMb2dnZXIubG9nRXJyb3IocGFyc2VFcnJvcik7XG5cbiAgICAgIHJldHVybiBvblJldHVybk9iamVjdCh7XG4gICAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgICAgYm9keTogYCR7cGFyc2VFcnJvci5tZXNzYWdlfSAtICR7ZSAmJiBlLm1lc3NhZ2UgPyBlLm1lc3NhZ2UgOiBcIlwifWBcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICBsZXQgaGFuZGxlckNhbGxXcmFwcGVyID0gKC4uLmFyZ3MpID0+IHtcbiAgICByZXR1cm4gaGFuZGxlciguLi5hcmdzKTtcbiAgfTtcblxuICAvKipcbiAgICpcbiAgICogQ09ORklHVVJBQkxFUyAtIEVORFxuICAgKlxuICAgKiAqL1xuXG4gIGNvbnN0IGNvbmZpZ3VyZSA9ICh7IGF1Z21lbnRNZXRob2RzID0ge30gfSA9IHt9KSA9PiB7XG4gICAgY29uc3QgY29uZmlndXJhYmxlTWV0aG9kcyA9IFtcbiAgICAgIFwib25DYXRjaFwiLFxuICAgICAgXCJvblJldHVybk9iamVjdFwiLFxuICAgICAgXCJoYW5kbGVyQ2FsbFdyYXBwZXJcIixcbiAgICAgIFwicHZ0TG9nZ2VyXCJcbiAgICBdO1xuXG4gICAgY29uZmlndXJhYmxlTWV0aG9kcy5mb3JFYWNoKGZuTmFtZSA9PiB7XG4gICAgICBjb25zdCBuZXdNZXRob2QgPSBhdWdtZW50TWV0aG9kc1tmbk5hbWVdO1xuICAgICAgaWYgKHR5cGVvZiBuZXdNZXRob2QgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBpZiAoZm5OYW1lID09PSBcIm9uUmV0dXJuT2JqZWN0XCIpIHtcbiAgICAgICAgICBjb25zdCBvbGRNZXRob2QgPSBvblJldHVybk9iamVjdDtcbiAgICAgICAgICBvblJldHVybk9iamVjdCA9IChhcmcxLCBwYXJhbXMpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGFyZzEpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBhcmcxLFxuICAgICAgICAgICAgICAuLi5wYXJhbXNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSBpZiAoZm5OYW1lID09PSBcIm9uQ2F0Y2hcIikge1xuICAgICAgICAgIGNvbnN0IG9sZE1ldGhvZCA9IG9uQ2F0Y2g7XG4gICAgICAgICAgb25DYXRjaCA9IChhcmcxLCBwYXJhbXMpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGFyZzEpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBhcmcxLFxuICAgICAgICAgICAgICAuLi5wYXJhbXNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSBpZiAoZm5OYW1lID09PSBcImhhbmRsZXJDYWxsV3JhcHBlclwiKSB7XG4gICAgICAgICAgY29uc3Qgb2xkTWV0aG9kID0gaGFuZGxlckNhbGxXcmFwcGVyO1xuICAgICAgICAgIGhhbmRsZXJDYWxsV3JhcHBlciA9IGUgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ld01ldGhvZCgoKSA9PiBvbGRNZXRob2QoZSksIHtcbiAgICAgICAgICAgICAgcHJldlJhd01ldGhvZDogb2xkTWV0aG9kLFxuICAgICAgICAgICAgICBhcmc6IGVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSBpZiAoZm5OYW1lID09PSBcInB2dExvZ2dlclwiKSB7XG4gICAgICAgICAgY29uc3Qgb2xkTWV0aG9kID0gcHZ0TG9nZ2VyO1xuICAgICAgICAgIHB2dExvZ2dlciA9IGUgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ld01ldGhvZCgoKSA9PiBvbGRNZXRob2QoZSksIHtcbiAgICAgICAgICAgICAgcHJldlJhd01ldGhvZDogb2xkTWV0aG9kLFxuICAgICAgICAgICAgICBhcmc6IGVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcblxuICAvKiBpbml0IGNvbmZpZ3VyYWJsZXMgKi9cbiAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb25maWd1cmUpIHtcbiAgICBjb25maWd1cmUob3B0aW9ucy5jb25maWd1cmUpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIENPUkUgLSBTVEFSVFxuICAgKlxuICAgKiAqL1xuXG4gIC8qIEZ1bmN0aW9uIE9iamVjdCBJbml0IFwiQmVmb3JlIEhvb2tcIiAqL1xuICBjb25zdCBGT0luaXRCZWZvcmVIb29rID0gKC4uLmFyZ3MpID0+IHtcbiAgICBpZiAoaXNIYW5kbGVyRmVkID09PSB0cnVlKSB7XG4gICAgICBoYW5kbGVyTGVuZ3RoID0gaGFuZGxlci5sZW5ndGg7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBhcmdzWzBdID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBwdnRMb2dnZXIubG9nV2FybmluZyhgXCJ1bmRlZmluZWRcIiBpcyBwcm9iYWJseSBub3QgZXhwZWN0ZWQgaGVyZS5gKTtcbiAgICB9XG5cbiAgICBpZiAoaXNIYW5kbGVyRmVkID09PSBmYWxzZSAmJiBBcnJheS5pc0FycmF5KGFyZ3NbMF0pKSB7XG4gICAgICBpZiAoYXJnc1swXS5ldmVyeShmbiA9PiB0eXBlb2YgZm4gPT09IFwiZnVuY3Rpb25cIikpIHtcbiAgICAgICAgY29uc3QgRk9BcnJheSA9IGFyZ3NbMF0ubWFwKGl0ZW0gPT4gQ3JlYXRlSW5zdGFuY2Uob3B0aW9ucykoaXRlbSkpO1xuICAgICAgICBGT0FycmF5LnVzZSA9ICguLi51c2VBcmdzKSA9PiB7XG4gICAgICAgICAgY29uc3QgRk9BcnJheUlubmVyID0gRk9BcnJheS5tYXAoaW5zdGFuY2UgPT4gaW5zdGFuY2UudXNlKC4uLnVzZUFyZ3MpKVxuICAgICAgICAgIEZPQXJyYXlJbm5lci51c2UgPSBGT0FycmF5LnVzZTtcbiAgICAgICAgICByZXR1cm4gRk9BcnJheUlubmVyO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBGT0FycmF5O1xuICAgICAgfVxuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIFwiYmVmb3JlLWhvb2sgY2FuIG9ubHkgYmUgdXNlZCBmb3IgZnVuY3Rpb25zLiBPbmUgb2YgdGhlIGl0ZW0gaW4gYXJyYXlzIGlzIG5vdC5cIlxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGlmIChoYW5kbGVyTGVuZ3RoID4gLTEgJiYgaGFuZGxlckxlbmd0aCAhPT0gYXJncy5sZW5ndGgpIHtcbiAgICAgICAgcHZ0TG9nZ2VyLmxvZ1dhcm5pbmcoXG4gICAgICAgICAgYERpc3BhdGNoaW5nIHdpdGggJHtcbiAgICAgICAgICAgIGFyZ3MubGVuZ3RoXG4gICAgICAgICAgfSBhcmdzIHdoaWxlIHRoZSBvcmlnaW5hbCBoYW5kbGVyIGhhcyAke2hhbmRsZXJMZW5ndGh9LmBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIEZPRGlzcGF0Y2goLi4uYXJncyk7XG4gICAgfVxuXG4gICAgaWYgKGlzSGFuZGxlckZlZCA9PT0gdHJ1ZSAmJiBhcmdzWzBdW1NZTUJPTF9NSURETEVXQVJFX0lEXSAhPT0gdHJ1ZSkge1xuICAgICAgLyogdGhlbiB3ZSBhc3N1bWUgdGhpcyBzY2VuYXJpbyBjYWxscyBmb3IgYSBuZXcgaW5zdGFuY2UgKi9cbiAgICAgIHJldHVybiBDcmVhdGVJbnN0YW5jZShvcHRpb25zKShhcmdzWzBdKTtcbiAgICB9XG5cbiAgICBbaGFuZGxlcl0gPSBhcmdzO1xuXG4gICAgaXNIYW5kbGVyRmVkID0gdHJ1ZTtcblxuICAgIHJldHVybiBGT0Rpc3BhdGNoO1xuICB9O1xuXG4gIEZPSW5pdEJlZm9yZUhvb2sudXNlID0gKC4uLmFyZ3MpID0+IHtcbiAgICBpZiAoIWFyZ3MgfHwgIWFyZ3NbMF0pIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBgLnVzZSBleHBlY3RzIGFuIGluc3RhbmNlIGZyb20gQmFzZU1pZGRsZXdhcmUuIChHb3QgdHlwZSBcIiR7dHlwZW9mIGFyZ3NbMF19XCIpYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoaXNIYW5kbGVyRmVkID09PSBmYWxzZSkge1xuICAgICAgdGhyb3cgRXJyb3IoXCJBIGhhbmRsZXIgbmVlZHMgdG8gYmUgZmVkIGZpcnN0IGJlZm9yZSBjYWxsaW5nIC51c2VcIik7XG4gICAgfVxuXG4gICAgaWYgKGFyZ3MubGVuZ3RoID4gMSkge1xuICAgICAgcHZ0TG9nZ2VyLmxvZ1dhcm5pbmcoXG4gICAgICAgIGBJZ25vcmluZyAybmQgYXJndW1lbnQuIFwidXNlXCIgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBtb3JlIHRoYW4gMSBhcmd1bWVudC5gXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAocHZ0RGlzcGF0Y2hlZCA9PT0gdHJ1ZSkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIFwiVXNpbmcgbWlkZGxld2FyZXMgYWdhaW4gYWZ0ZXIgaGFuZGxlcidzIGludm9jYXRpb24gaXMgbm90IGFsbG93ZWQuXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgbWlkZGxld2FyZSA9IGFyZ3NbMF07XG5cbiAgICBpZiAobWlkZGxld2FyZVtTWU1CT0xfTUlERExFV0FSRV9JRF0gPT09IHRydWUpIHtcbiAgICAgIHN0YWNrZWRIb29rcy5wdXNoKG1pZGRsZXdhcmUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgXCJVbmtub3duIG1pZGRsZXdhcmUuIE1pZGRsZXdhcmVzIG11c3QgZXh0ZW5kIEJhc2VNaWRkbGV3YXJlLlwiXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBGT0luaXRCZWZvcmVIb29rO1xuICB9O1xuXG4gIEZPSW5pdEJlZm9yZUhvb2suc2V0TG9nZ2VyID0gbmV3TG9nZ2VyID0+IHtcbiAgICBwdnRMb2dnZXIgPSBuZXdMb2dnZXI7XG4gIH07XG5cbiAgRk9Jbml0QmVmb3JlSG9vay5nZXRMb2dnZXIgPSAoKSA9PiBwdnRMb2dnZXI7XG5cbiAgRk9EaXNwYXRjaCA9IGFzeW5jICguLi5hcmdzKSA9PiB7XG4gICAgbGV0IGhvb2tCZWZvcmVDYXRjaGluZyA9IHt9O1xuICAgIHB2dERpc3BhdGNoZWQgPSB0cnVlO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZXN0cmljdGVkLXN5bnRheCAqL1xuICAgICAgZm9yIChjb25zdCBob29rIG9mIHN0YWNrZWRIb29rcykge1xuICAgICAgICBob29rQmVmb3JlQ2F0Y2hpbmcgPSBob29rO1xuXG4gICAgICAgIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1hd2FpdC1pbi1sb29wICovXG4gICAgICAgIGF3YWl0IGhvb2soLi4uYXJncyk7XG4gICAgICAgIC8vIGNvbnN0IGV4dGVuc2lvbnMgPSBhd2FpdCBob29rKC4uLmFyZ3MpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKG1pZGRsZXdhcmVzVGhyb3cpIHtcbiAgICAgIGlmIChtaWRkbGV3YXJlc1Rocm93W1NZTUJPTF9TSE9SVF9DSVJDVUlUX1RZUEVdID09PSBcInJlcGx5XCIpIHtcbiAgICAgICAgaWYgKHNldHRpbmdzLnN0b3BPbkNhdGNoID09PSB0cnVlKSB7XG4gICAgICAgICAgcmV0dXJuIG9uUmVwbHkoSlNPTi5wYXJzZShtaWRkbGV3YXJlc1Rocm93Lm1lc3NhZ2UpKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBjYXRjaEhhbmRsZXJUb1VzZSA9XG4gICAgICAgIHR5cGVvZiBob29rQmVmb3JlQ2F0Y2hpbmdbU1lNQk9MX01JRERMRVdBUkVfT05fQ0FUQ0hdID09PSBcImZ1bmN0aW9uXCJcbiAgICAgICAgICA/IChlcnIsIHBhcmFtcykgPT5cbiAgICAgICAgICAgICAgaG9va0JlZm9yZUNhdGNoaW5nW1NZTUJPTF9NSURETEVXQVJFX09OX0NBVENIXShcbiAgICAgICAgICAgICAgICBlID0+IG9uQ2F0Y2goZSwgcGFyYW1zKSxcbiAgICAgICAgICAgICAgICBlcnJcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgIDogKGVyciwgcGFyYW1zKSA9PiBvbkNhdGNoKGVyciwgcGFyYW1zKTtcbiAgICAgIGlmIChzZXR0aW5ncy5zdG9wT25DYXRjaCA9PT0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gY2F0Y2hIYW5kbGVyVG9Vc2UobWlkZGxld2FyZXNUaHJvdywge1xuICAgICAgICAgIGdldFBhcmFtczogKCkgPT4gYXJnc1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGNhdGNoSGFuZGxlclRvVXNlKG1pZGRsZXdhcmVzVGhyb3csIHtcbiAgICAgICAgZ2V0UGFyYW1zOiAoKSA9PiBhcmdzXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gaGFuZGxlckNhbGxXcmFwcGVyKC4uLmFyZ3MpO1xuICB9O1xuXG4gIC8qIGNvcHkgcHJvcGVydGllcyBvZiBGT0luaXRCZWZvcmVIb29rIHRvIEZPRGlzcGF0Y2ggLSBzbyB3ZSBjYW4gY2hhaW4gLnVzZSBhbmQgZXRjICovXG4gIE9iamVjdC5rZXlzKEZPSW5pdEJlZm9yZUhvb2spLmZvckVhY2gobWV0aG9kID0+IHtcbiAgICBGT0Rpc3BhdGNoW21ldGhvZF0gPSBGT0luaXRCZWZvcmVIb29rW21ldGhvZF07XG4gIH0pO1xuXG4gIC8qKlxuICAgKlxuICAgKiBDT1JFIC0gRU5EXG4gICAqXG4gICAqICovXG5cbiAgcmV0dXJuIEZPSW5pdEJlZm9yZUhvb2s7XG59O1xuXG5leHBvcnQgeyBCYXNlTWlkZGxld2FyZSwgQm9keVBhcnNlck1pZGRsZXdhcmUsIENyZWF0ZUluc3RhbmNlIH07XG5cbmV4cG9ydCBkZWZhdWx0IENyZWF0ZUluc3RhbmNlO1xuIl19
