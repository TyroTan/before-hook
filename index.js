"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CreateInstance = exports.BodyParserMiddleware = exports.BaseMiddleware = void 0;

require("source-map-support/register");

const SYMBOL_ERR_TYPE = Symbol("SYMBOL_ERR_TYPE");
const SYMBOL_BEFOREHOOK_MIDDLEWARE_ID = Symbol("SYMBOL_BEFOREHOOK_MIDDLEWARE_ID");

const objectAssignIfExists = (...args) => {
  const def = { ...args[1]
  };
  const overrideIfExist = { ...args[2]
  };
  Object.keys(def).forEach(k => {
    if (overrideIfExist[k]) {
      def[k] = overrideIfExist[k];
    }
  });
  return { ...args[0],
    ...def
  };
};

const MiddlewareHelpersInit = () => {
  const pvtLogger = {
    /* eslint-disable-next-line no-console */
    log: (...args) => args.forEach(l => console.log(l.message || l)),

    /* eslint-disable-next-line no-console */
    logError: (...args) => args.forEach(l => console.error(l.message || l))
  };

  const returnAndSendResponse = obj => {
    /* eslint-disable-next-line no-param-reassign */
    const customError = Error(JSON.stringify(obj));
    customError[SYMBOL_ERR_TYPE] = true;
    throw customError;
  };

  return () => ({
    returnAndSendResponse,
    getLogger: () => pvtLogger
  });
};
/* deprecated const setState = (objs, oldState, state) => {
  const mutatedOldState = oldState;
  const newState = state;

  Object.keys(objs).forEach(key => {
    newState[key] = objs[key];
    mutatedOldState[key] = objs[key];
  });

  return mutatedOldState;
};
const setContext = setState; */

/* deprecated const simpleClone = objectToClone =>
  /* JSON.parse(JSON.stringify( * / objectToClone; /* )) * /
const clone = simpleClone; */


const BaseMiddlewareHandlerInit = handler => {
  const dispatchFn = async (...args) => {
    await handler({
      getParams: () => args,
      getHelpers: MiddlewareHelpersInit()
    }, {});
    return args;
  };

  return dispatchFn;
};

const BaseMiddleware = ({
  handler,
  configure
} = {}) => {
  if (!(typeof handler === "function")) {
    throw Error(`Custom middlewares must define a "handler"`);
  }

  let pre = async () => {};

  pre = BaseMiddlewareHandlerInit(handler);
  pre[SYMBOL_BEFOREHOOK_MIDDLEWARE_ID] = true;

  if (configure && configure.augmentMethods) {
    const {
      augmentMethods = {}
    } = configure;
    const configurableMethods = ["onCatch"];
    configurableMethods.forEach(fnName => {
      const newMethod = augmentMethods[fnName];

      if (typeof newMethod === "function") {
        if (fnName === "onCatch") {
          pre.scrtOnCatch = (oldMethod, e) => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        }
      }
    });
  }

  return pre;
};

exports.BaseMiddleware = BaseMiddleware;

const BodyParserMiddleware = () => {
  return BaseMiddleware({
    handler: async ({
      getParams
    }) => {
      const [event] = getParams();

      if (Object.keys({ ...event.body
      }).length) {
        event.body = JSON.parse(event.body);
      }
    }
  });
};

exports.BodyParserMiddleware = BodyParserMiddleware;

const CreateInstance = options => {
  let settings = {
    DEBUG: false,
    stopOnCatch: true
  };
  settings = objectAssignIfExists({}, settings, options);
  let pvtDispatched = false;
  const stackedHooks = [];
  let isHandlerFed = false;
  let handlerLength = -1;

  let handler = async () => {};

  let FODispatch = async () => {};
  /*
   *
   * CONFIGURABLES - START
   *
   */


  let pvtLogger = {
    /* eslint-disable-next-line no-console */
    log: (...args) => args.forEach(l => console.log(l.message || l)),

    /* eslint-disable-next-line no-console */
    logError: (...args) => args.forEach(l => console.error(l.message || l)),
    logWarning: (...args) =>
    /* eslint-disable-next-line no-console */
    args.forEach(l => console.error(`WARNING: ${l.message || l}`))
  };
  /* logs are off by default */

  if (settings.DEBUG !== true) {
    pvtLogger.log = () => {};

    pvtLogger.logError = () => {};

    pvtLogger.logWarning = () => {};
  }

  let onCatch = (...args) => {
    const [e] = args;

    try {
      if (e[SYMBOL_ERR_TYPE] === true) {
        return JSON.parse(e.message);
      }

      pvtLogger.logError(e);
      return {
        statusCode: 500,
        body: `${e.message}`
      };
    } catch (parseError) {
      pvtLogger.logError(parseError);
      return {
        statusCode: 500,
        body: `${parseError.message} - ${e && e.message ? e.message : ""}`
      };
    }
  };

  let handlerCallWrapper = (...args) => {
    return handler(...args);
  };
  /**
   *
   * CONFIGURABLES - END
   *
   * */


  const configure = ({
    augmentMethods = {}
  } = {}) => {
    const configurableMethods = ["onCatch", "handlerCallWrapper", "pvtLogger"];
    configurableMethods.forEach(fnName => {
      const newMethod = augmentMethods[fnName];

      if (typeof newMethod === "function") {
        if (fnName === "onCatch") {
          const oldMethod = onCatch;

          onCatch = (arg1, params) => {
            return newMethod(() => oldMethod(arg1), {
              prevRawMethod: oldMethod,
              arg: arg1,
              ...params
            });
          };
        } else if (fnName === "handlerCallWrapper") {
          const oldMethod = handlerCallWrapper;

          handlerCallWrapper = e => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        } else if (fnName === "pvtLogger") {
          const oldMethod = pvtLogger;

          pvtLogger = e => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        }
      }
    });
  };
  /* init configurables */


  if (options && options.configure) {
    configure(options.configure);
  }
  /**
   *
   * CORE - START
   *
   * */

  /* Function Object Init "Before Hook" */


  const FOInitBeforeHook = (...args) => {
    if (isHandlerFed === true) {
      handlerLength = handler.length;
    }

    if (typeof args[0] === "undefined") {
      pvtLogger.logWarning(`"undefined" is probably not expected here.`);
    }

    if (typeof args[0] !== "function") {
      if (handlerLength > -1 && handlerLength !== args.length) {
        pvtLogger.logWarning(`Dispatching with ${args.length} args while the original handler has ${handlerLength}.`);
      }

      return FODispatch(...args);
    }
    /* if (isHandlerFed === false && validateHandler(args[0]) === false) {
      throw Error(
        `DEPRECATED - Please use the exact argument names of the handler as the following event,context,callback or simply (event, context) => {} or () => {}`
      );
    } */


    if (isHandlerFed === true && args[0][SYMBOL_BEFOREHOOK_MIDDLEWARE_ID] !== true) {
      /* then we assume this scenario calls for a new instance */
      return CreateInstance(options)(args[0]);
    }

    [handler] = args;
    isHandlerFed = true;
    return FODispatch;
  };

  FOInitBeforeHook.use = (...args) => {
    if (isHandlerFed === false) {
      throw Error("A handler needs to be fed first before calling .use");
    }

    if (args.length > 1) {
      pvtLogger.logWarning(`Ignoring 2nd argument. "use" method was called with more than 1 argument.`);
    }

    if (pvtDispatched === true) {
      throw Error("Using middlewares again after handler's invocation is not allowed.");
    }

    const middleware = args[0];

    if (middleware[SYMBOL_BEFOREHOOK_MIDDLEWARE_ID] === true) {
      stackedHooks.push(middleware);
    } else {
      throw Error("Unknown middleware. Middlewares must extend BaseMiddleware.");
    }

    return FOInitBeforeHook;
  };

  FOInitBeforeHook.setLogger = newLogger => {
    pvtLogger = newLogger;
  };

  FOInitBeforeHook.getLogger = () => pvtLogger;

  FODispatch = async (...args) => {
    let hookBeforeCatching = {};
    pvtDispatched = true;

    try {
      /* eslint-disable-next-line no-restricted-syntax */
      for (const hook of stackedHooks) {
        hookBeforeCatching = hook;
        /* eslint-disable-next-line no-await-in-loop */

        await hook(...args); // const extensions = await hook(...args);
      }
    } catch (middlewaresThrow) {
      const catchHandlerToUse = typeof hookBeforeCatching.scrtOnCatch === "function" ? (err, params) => hookBeforeCatching.scrtOnCatch(e => onCatch(e, params), err) : (err, params) => onCatch(err, params);

      if (settings.stopOnCatch === true) {
        return catchHandlerToUse(middlewaresThrow, {
          getParams: () => args
        });
      }

      catchHandlerToUse(middlewaresThrow, {
        getParams: () => args
      });
    }

    return handlerCallWrapper(...args);
  };
  /* copy properties of FOInitBeforeHook to FODispatch - so we can chain .use and etc */


  Object.keys(FOInitBeforeHook).forEach(method => {
    FODispatch[method] = FOInitBeforeHook[method];
  });
  /**
   *
   * CORE - END
   *
   * */

  return FOInitBeforeHook;
};

exports.CreateInstance = CreateInstance;
var _default = CreateInstance;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnNvdXJjZS5qcyJdLCJuYW1lcyI6WyJTWU1CT0xfRVJSX1RZUEUiLCJTeW1ib2wiLCJTWU1CT0xfQkVGT1JFSE9PS19NSURETEVXQVJFX0lEIiwib2JqZWN0QXNzaWduSWZFeGlzdHMiLCJhcmdzIiwiZGVmIiwib3ZlcnJpZGVJZkV4aXN0IiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrIiwiTWlkZGxld2FyZUhlbHBlcnNJbml0IiwicHZ0TG9nZ2VyIiwibG9nIiwibCIsImNvbnNvbGUiLCJtZXNzYWdlIiwibG9nRXJyb3IiLCJlcnJvciIsInJldHVybkFuZFNlbmRSZXNwb25zZSIsIm9iaiIsImN1c3RvbUVycm9yIiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0TG9nZ2VyIiwiQmFzZU1pZGRsZXdhcmVIYW5kbGVySW5pdCIsImhhbmRsZXIiLCJkaXNwYXRjaEZuIiwiZ2V0UGFyYW1zIiwiZ2V0SGVscGVycyIsIkJhc2VNaWRkbGV3YXJlIiwiY29uZmlndXJlIiwicHJlIiwiYXVnbWVudE1ldGhvZHMiLCJjb25maWd1cmFibGVNZXRob2RzIiwiZm5OYW1lIiwibmV3TWV0aG9kIiwic2NydE9uQ2F0Y2giLCJvbGRNZXRob2QiLCJlIiwicHJldlJhd01ldGhvZCIsImFyZyIsIkJvZHlQYXJzZXJNaWRkbGV3YXJlIiwiZXZlbnQiLCJib2R5IiwibGVuZ3RoIiwicGFyc2UiLCJDcmVhdGVJbnN0YW5jZSIsIm9wdGlvbnMiLCJzZXR0aW5ncyIsIkRFQlVHIiwic3RvcE9uQ2F0Y2giLCJwdnREaXNwYXRjaGVkIiwic3RhY2tlZEhvb2tzIiwiaXNIYW5kbGVyRmVkIiwiaGFuZGxlckxlbmd0aCIsIkZPRGlzcGF0Y2giLCJsb2dXYXJuaW5nIiwib25DYXRjaCIsInN0YXR1c0NvZGUiLCJwYXJzZUVycm9yIiwiaGFuZGxlckNhbGxXcmFwcGVyIiwiYXJnMSIsInBhcmFtcyIsIkZPSW5pdEJlZm9yZUhvb2siLCJ1c2UiLCJtaWRkbGV3YXJlIiwicHVzaCIsInNldExvZ2dlciIsIm5ld0xvZ2dlciIsImhvb2tCZWZvcmVDYXRjaGluZyIsImhvb2siLCJtaWRkbGV3YXJlc1Rocm93IiwiY2F0Y2hIYW5kbGVyVG9Vc2UiLCJlcnIiLCJtZXRob2QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE1BQU1BLGVBQWUsR0FBR0MsTUFBTSxDQUFDLGlCQUFELENBQTlCO0FBQ0EsTUFBTUMsK0JBQStCLEdBQUdELE1BQU0sQ0FDNUMsaUNBRDRDLENBQTlDOztBQUlBLE1BQU1FLG9CQUFvQixHQUFHLENBQUMsR0FBR0MsSUFBSixLQUFhO0FBQ3hDLFFBQU1DLEdBQUcsR0FBRyxFQUFFLEdBQUdELElBQUksQ0FBQyxDQUFEO0FBQVQsR0FBWjtBQUNBLFFBQU1FLGVBQWUsR0FBRyxFQUFFLEdBQUdGLElBQUksQ0FBQyxDQUFEO0FBQVQsR0FBeEI7QUFDQUcsRUFBQUEsTUFBTSxDQUFDQyxJQUFQLENBQVlILEdBQVosRUFBaUJJLE9BQWpCLENBQXlCQyxDQUFDLElBQUk7QUFDNUIsUUFBSUosZUFBZSxDQUFDSSxDQUFELENBQW5CLEVBQXdCO0FBQ3RCTCxNQUFBQSxHQUFHLENBQUNLLENBQUQsQ0FBSCxHQUFTSixlQUFlLENBQUNJLENBQUQsQ0FBeEI7QUFDRDtBQUNGLEdBSkQ7QUFNQSxTQUFPLEVBQUUsR0FBR04sSUFBSSxDQUFDLENBQUQsQ0FBVDtBQUFjLE9BQUdDO0FBQWpCLEdBQVA7QUFDRCxDQVZEOztBQVlBLE1BQU1NLHFCQUFxQixHQUFHLE1BQU07QUFDbEMsUUFBTUMsU0FBUyxHQUFHO0FBQ2hCO0FBQ0FDLElBQUFBLEdBQUcsRUFBRSxDQUFDLEdBQUdULElBQUosS0FBYUEsSUFBSSxDQUFDSyxPQUFMLENBQWFLLENBQUMsSUFBSUMsT0FBTyxDQUFDRixHQUFSLENBQVlDLENBQUMsQ0FBQ0UsT0FBRixJQUFhRixDQUF6QixDQUFsQixDQUZGOztBQUloQjtBQUNBRyxJQUFBQSxRQUFRLEVBQUUsQ0FBQyxHQUFHYixJQUFKLEtBQWFBLElBQUks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QUFVLENBQUNtQixNQUFELENBQVYsR0FBcUJYLGdCQUFnQixDQUFDVyxNQUFELENBQXJDO0FBQ0QsR0FGRDtBQUlBOzs7Ozs7QUFNQSxTQUFPWCxnQkFBUDtBQUNELENBbFBEOzs7ZUFzUGVqQixjIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgU1lNQk9MX0VSUl9UWVBFID0gU3ltYm9sKFwiU1lNQk9MX0VSUl9UWVBFXCIpO1xuY29uc3QgU1lNQk9MX0JFRk9SRUhPT0tfTUlERExFV0FSRV9JRCA9IFN5bWJvbChcbiAgXCJTWU1CT0xfQkVGT1JFSE9PS19NSURETEVXQVJFX0lEXCJcbik7XG5cbmNvbnN0IG9iamVjdEFzc2lnbklmRXhpc3RzID0gKC4uLmFyZ3MpID0+IHtcbiAgY29uc3QgZGVmID0geyAuLi5hcmdzWzFdIH07XG4gIGNvbnN0IG92ZXJyaWRlSWZFeGlzdCA9IHsgLi4uYXJnc1syXSB9O1xuICBPYmplY3Qua2V5cyhkZWYpLmZvckVhY2goayA9PiB7XG4gICAgaWYgKG92ZXJyaWRlSWZFeGlzdFtrXSkge1xuICAgICAgZGVmW2tdID0gb3ZlcnJpZGVJZkV4aXN0W2tdO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHsgLi4uYXJnc1swXSwgLi4uZGVmIH07XG59O1xuXG5jb25zdCBNaWRkbGV3YXJlSGVscGVyc0luaXQgPSAoKSA9PiB7XG4gIGNvbnN0IHB2dExvZ2dlciA9IHtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZzogKC4uLmFyZ3MpID0+IGFyZ3MuZm9yRWFjaChsID0+IGNvbnNvbGUubG9nKGwubWVzc2FnZSB8fCBsKSksXG5cbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZ0Vycm9yOiAoLi4uYXJncykgPT4gYXJncy5mb3JFYWNoKGwgPT4gY29uc29sZS5lcnJvcihsLm1lc3NhZ2UgfHwgbCkpXG4gIH07XG5cbiAgY29uc3QgcmV0dXJuQW5kU2VuZFJlc3BvbnNlID0gb2JqID0+IHtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cbiAgICBjb25zdCBjdXN0b21FcnJvciA9IEVycm9yKEpTT04uc3RyaW5naWZ5KG9iaikpO1xuICAgIGN1c3RvbUVycm9yW1NZTUJPTF9FUlJfVFlQRV0gPSB0cnVlO1xuXG4gICAgdGhyb3cgY3VzdG9tRXJyb3I7XG4gIH07XG5cbiAgcmV0dXJuICgpID0+ICh7XG4gICAgcmV0dXJuQW5kU2VuZFJlc3BvbnNlLFxuICAgIGdldExvZ2dlcjogKCkgPT4gcHZ0TG9nZ2VyXG4gIH0pO1xufTtcblxuLyogZGVwcmVjYXRlZCBjb25zdCBzZXRTdGF0ZSA9IChvYmpzLCBvbGRTdGF0ZSwgc3RhdGUpID0+IHtcbiAgY29uc3QgbXV0YXRlZE9sZFN0YXRlID0gb2xkU3RhdGU7XG4gIGNvbnN0IG5ld1N0YXRlID0gc3RhdGU7XG5cbiAgT2JqZWN0LmtleXMob2JqcykuZm9yRWFjaChrZXkgPT4ge1xuICAgIG5ld1N0YXRlW2tleV0gPSBvYmpzW2tleV07XG4gICAgbXV0YXRlZE9sZFN0YXRlW2tleV0gPSBvYmpzW2tleV07XG4gIH0pO1xuXG4gIHJldHVybiBtdXRhdGVkT2xkU3RhdGU7XG59O1xuY29uc3Qgc2V0Q29udGV4dCA9IHNldFN0YXRlOyAqL1xuLyogZGVwcmVjYXRlZCBjb25zdCBzaW1wbGVDbG9uZSA9IG9iamVjdFRvQ2xvbmUgPT5cbiAgLyogSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSggKiAvIG9iamVjdFRvQ2xvbmU7IC8qICkpICogL1xuY29uc3QgY2xvbmUgPSBzaW1wbGVDbG9uZTsgKi9cblxuY29uc3QgQmFzZU1pZGRsZXdhcmVIYW5kbGVySW5pdCA9IGhhbmRsZXIgPT4ge1xuICBjb25zdCBkaXNwYXRjaEZuID0gYXN5bmMgKC4uLmFyZ3MpID0+IHtcbiAgICBhd2FpdCBoYW5kbGVyKFxuICAgICAge1xuICAgICAgICBnZXRQYXJhbXM6ICgpID0+IGFyZ3MsXG4gICAgICAgIGdldEhlbHBlcnM6IE1pZGRsZXdhcmVIZWxwZXJzSW5pdCgpXG4gICAgICB9LFxuICAgICAge31cbiAgICApO1xuXG4gICAgcmV0dXJuIGFyZ3M7XG4gIH07XG5cbiAgcmV0dXJuIGRpc3BhdGNoRm47XG59O1xuXG5jb25zdCBCYXNlTWlkZGxld2FyZSA9ICh7IGhhbmRsZXIsIGNvbmZpZ3VyZSB9ID0ge30pID0+IHtcbiAgaWYgKCEodHlwZW9mIGhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikpIHtcbiAgICB0aHJvdyBFcnJvcihgQ3VzdG9tIG1pZGRsZXdhcmVzIG11c3QgZGVmaW5lIGEgXCJoYW5kbGVyXCJgKTtcbiAgfVxuXG4gIGxldCBwcmUgPSBhc3luYyAoKSA9PiB7fTtcbiAgcHJlID0gQmFzZU1pZGRsZXdhcmVIYW5kbGVySW5pdChoYW5kbGVyKTtcblxuICBwcmVbU1lNQk9MX0JFRk9SRUhPT0tfTUlERExFV0FSRV9JRF0gPSB0cnVlO1xuXG4gIGlmIChjb25maWd1cmUgJiYgY29uZmlndXJlLmF1Z21lbnRNZXRob2RzKSB7XG4gICAgY29uc3QgeyBhdWdtZW50TWV0aG9kcyA9IHt9IH0gPSBjb25maWd1cmU7XG4gICAgY29uc3QgY29uZmlndXJhYmxlTWV0aG9kcyA9IFtcIm9uQ2F0Y2hcIl07XG5cbiAgICBjb25maWd1cmFibGVNZXRob2RzLmZvckVhY2goZm5OYW1lID0+IHtcbiAgICAgIGNvbnN0IG5ld01ldGhvZCA9IGF1Z21lbnRNZXRob2RzW2ZuTmFtZV07XG5cbiAgICAgIGlmICh0eXBlb2YgbmV3TWV0aG9kID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgaWYgKGZuTmFtZSA9PT0gXCJvbkNhdGNoXCIpIHtcbiAgICAgICAgICBwcmUuc2NydE9uQ2F0Y2ggPSAob2xkTWV0aG9kLCBlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3TWV0aG9kKCgpID0+IG9sZE1ldGhvZChlKSwge1xuICAgICAgICAgICAgICBwcmV2UmF3TWV0aG9kOiBvbGRNZXRob2QsXG4gICAgICAgICAgICAgIGFyZzogZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHByZTtcbn07XG5cbmNvbnN0IEJvZHlQYXJzZXJNaWRkbGV3YXJlID0gKCkgPT4ge1xuICByZXR1cm4gQmFzZU1pZGRsZXdhcmUoe1xuICAgIGhhbmRsZXI6IGFzeW5jICh7IGdldFBhcmFtcyB9KSA9PiB7XG4gICAgICBjb25zdCBbZXZlbnRdID0gZ2V0UGFyYW1zKCk7XG4gICAgICBpZiAoT2JqZWN0LmtleXMoeyAuLi5ldmVudC5ib2R5IH0pLmxlbmd0aCkge1xuICAgICAgICBldmVudC5ib2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufTtcblxuY29uc3QgQ3JlYXRlSW5zdGFuY2UgPSBvcHRpb25zID0+IHtcbiAgbGV0IHNldHRpbmdzID0ge1xuICAgIERFQlVHOiBmYWxzZSxcbiAgICBzdG9wT25DYXRjaDogdHJ1ZVxuICB9O1xuXG4gIHNldHRpbmdzID0gb2JqZWN0QXNzaWduSWZFeGlzdHMoe30sIHNldHRpbmdzLCBvcHRpb25zKTtcblxuICBsZXQgcHZ0RGlzcGF0Y2hlZCA9IGZhbHNlO1xuICBjb25zdCBzdGFja2VkSG9va3MgPSBbXTtcbiAgbGV0IGlzSGFuZGxlckZlZCA9IGZhbHNlO1xuICBsZXQgaGFuZGxlckxlbmd0aCA9IC0xO1xuXG4gIGxldCBoYW5kbGVyID0gYXN5bmMgKCkgPT4ge307XG4gIGxldCBGT0Rpc3BhdGNoID0gYXN5bmMgKCkgPT4ge307XG5cbiAgLypcbiAgICpcbiAgICogQ09ORklHVVJBQkxFUyAtIFNUQVJUXG4gICAqXG4gICAqL1xuXG4gIGxldCBwdnRMb2dnZXIgPSB7XG4gICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGUgKi9cbiAgICBsb2c6ICguLi5hcmdzKSA9PiBhcmdzLmZvckVhY2gobCA9PiBjb25zb2xlLmxvZyhsLm1lc3NhZ2UgfHwgbCkpLFxuXG4gICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGUgKi9cbiAgICBsb2dFcnJvcjogKC4uLmFyZ3MpID0+IGFyZ3MuZm9yRWFjaChsID0+IGNvbnNvbGUuZXJyb3IobC5tZXNzYWdlIHx8IGwpKSxcblxuICAgIGxvZ1dhcm5pbmc6ICguLi5hcmdzKSA9PlxuICAgICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGUgKi9cbiAgICAgIGFyZ3MuZm9yRWFjaChsID0+IGNvbnNvbGUuZXJyb3IoYFdBUk5JTkc6ICR7bC5tZXNzYWdlIHx8IGx9YCkpXG4gIH07XG5cbiAgLyogbG9ncyBhcmUgb2ZmIGJ5IGRlZmF1bHQgKi9cbiAgaWYgKHNldHRpbmdzLkRFQlVHICE9PSB0cnVlKSB7XG4gICAgcHZ0TG9nZ2VyLmxvZyA9ICgpID0+IHt9O1xuICAgIHB2dExvZ2dlci5sb2dFcnJvciA9ICgpID0+IHt9O1xuICAgIHB2dExvZ2dlci5sb2dXYXJuaW5nID0gKCkgPT4ge307XG4gIH1cblxuICBsZXQgb25DYXRjaCA9ICguLi5hcmdzKSA9PiB7XG4gICAgY29uc3QgW2VdID0gYXJncztcblxuICAgIHRyeSB7XG4gICAgICBpZiAoZVtTWU1CT0xfRVJSX1RZUEVdID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGUubWVzc2FnZSk7XG4gICAgICB9XG5cbiAgICAgIHB2dExvZ2dlci5sb2dFcnJvcihlKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgICBib2R5OiBgJHtlLm1lc3NhZ2V9YFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChwYXJzZUVycm9yKSB7XG4gICAgICBwdnRMb2dnZXIubG9nRXJyb3IocGFyc2VFcnJvcik7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgICAgYm9keTogYCR7cGFyc2VFcnJvci5tZXNzYWdlfSAtICR7ZSAmJiBlLm1lc3NhZ2UgPyBlLm1lc3NhZ2UgOiBcIlwifWBcbiAgICAgIH07XG4gICAgfVxuICB9O1xuXG4gIGxldCBoYW5kbGVyQ2FsbFdyYXBwZXIgPSAoLi4uYXJncykgPT4ge1xuICAgIHJldHVybiBoYW5kbGVyKC4uLmFyZ3MpO1xuICB9O1xuXG4gIC8qKlxuICAgKlxuICAgKiBDT05GSUdVUkFCTEVTIC0gRU5EXG4gICAqXG4gICAqICovXG5cbiAgY29uc3QgY29uZmlndXJlID0gKHsgYXVnbWVudE1ldGhvZHMgPSB7fSB9ID0ge30pID0+IHtcbiAgICBjb25zdCBjb25maWd1cmFibGVNZXRob2RzID0gW1wib25DYXRjaFwiLCBcImhhbmRsZXJDYWxsV3JhcHBlclwiLCBcInB2dExvZ2dlclwiXTtcblxuICAgIGNvbmZpZ3VyYWJsZU1ldGhvZHMuZm9yRWFjaChmbk5hbWUgPT4ge1xuICAgICAgY29uc3QgbmV3TWV0aG9kID0gYXVnbWVudE1ldGhvZHNbZm5OYW1lXTtcbiAgICAgIGlmICh0eXBlb2YgbmV3TWV0aG9kID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgaWYgKGZuTmFtZSA9PT0gXCJvbkNhdGNoXCIpIHtcbiAgICAgICAgICBjb25zdCBvbGRNZXRob2QgPSBvbkNhdGNoO1xuICAgICAgICAgIG9uQ2F0Y2ggPSAoYXJnMSwgcGFyYW1zKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3TWV0aG9kKCgpID0+IG9sZE1ldGhvZChhcmcxKSwge1xuICAgICAgICAgICAgICBwcmV2UmF3TWV0aG9kOiBvbGRNZXRob2QsXG4gICAgICAgICAgICAgIGFyZzogYXJnMSxcbiAgICAgICAgICAgICAgLi4ucGFyYW1zXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKGZuTmFtZSA9PT0gXCJoYW5kbGVyQ2FsbFdyYXBwZXJcIikge1xuICAgICAgICAgIGNvbnN0IG9sZE1ldGhvZCA9IGhhbmRsZXJDYWxsV3JhcHBlcjtcbiAgICAgICAgICBoYW5kbGVyQ2FsbFdyYXBwZXIgPSBlID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGUpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKGZuTmFtZSA9PT0gXCJwdnRMb2dnZXJcIikge1xuICAgICAgICAgIGNvbnN0IG9sZE1ldGhvZCA9IHB2dExvZ2dlcjtcbiAgICAgICAgICBwdnRMb2dnZXIgPSBlID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGUpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgLyogaW5pdCBjb25maWd1cmFibGVzICovXG4gIGlmIChvcHRpb25zICYmIG9wdGlvbnMuY29uZmlndXJlKSB7XG4gICAgY29uZmlndXJlKG9wdGlvbnMuY29uZmlndXJlKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBDT1JFIC0gU1RBUlRcbiAgICpcbiAgICogKi9cblxuICAvKiBGdW5jdGlvbiBPYmplY3QgSW5pdCBcIkJlZm9yZSBIb29rXCIgKi9cbiAgY29uc3QgRk9Jbml0QmVmb3JlSG9vayA9ICguLi5hcmdzKSA9PiB7XG4gICAgaWYgKGlzSGFuZGxlckZlZCA9PT0gdHJ1ZSkge1xuICAgICAgaGFuZGxlckxlbmd0aCA9IGhhbmRsZXIubGVuZ3RoO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgcHZ0TG9nZ2VyLmxvZ1dhcm5pbmcoYFwidW5kZWZpbmVkXCIgaXMgcHJvYmFibHkgbm90IGV4cGVjdGVkIGhlcmUuYCk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBhcmdzWzBdICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGlmIChoYW5kbGVyTGVuZ3RoID4gLTEgJiYgaGFuZGxlckxlbmd0aCAhPT0gYXJncy5sZW5ndGgpIHtcbiAgICAgICAgcHZ0TG9nZ2VyLmxvZ1dhcm5pbmcoXG4gICAgICAgICAgYERpc3BhdGNoaW5nIHdpdGggJHtcbiAgICAgICAgICAgIGFyZ3MubGVuZ3RoXG4gICAgICAgICAgfSBhcmdzIHdoaWxlIHRoZSBvcmlnaW5hbCBoYW5kbGVyIGhhcyAke2hhbmRsZXJMZW5ndGh9LmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBGT0Rpc3BhdGNoKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIC8qIGlmIChpc0hhbmRsZXJGZWQgPT09IGZhbHNlICYmIHZhbGlkYXRlSGFuZGxlcihhcmdzWzBdKSA9PT0gZmFsc2UpIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBgREVQUkVDQVRFRCAtIFBsZWFzZSB1c2UgdGhlIGV4YWN0IGFyZ3VtZW50IG5hbWVzIG9mIHRoZSBoYW5kbGVyIGFzIHRoZSBmb2xsb3dpbmcgZXZlbnQsY29udGV4dCxjYWxsYmFjayBvciBzaW1wbHkgKGV2ZW50LCBjb250ZXh0KSA9PiB7fSBvciAoKSA9PiB7fWBcbiAgICAgICk7XG4gICAgfSAqL1xuXG4gICAgaWYgKFxuICAgICAgaXNIYW5kbGVyRmVkID09PSB0cnVlICYmXG4gICAgICBhcmdzWzBdW1NZTUJPTF9CRUZPUkVIT09LX01JRERMRVdBUkVfSURdICE9PSB0cnVlXG4gICAgKSB7XG4gICAgICAvKiB0aGVuIHdlIGFzc3VtZSB0aGlzIHNjZW5hcmlvIGNhbGxzIGZvciBhIG5ldyBpbnN0YW5jZSAqL1xuICAgICAgcmV0dXJuIENyZWF0ZUluc3RhbmNlKG9wdGlvbnMpKGFyZ3NbMF0pO1xuICAgIH1cblxuICAgIFtoYW5kbGVyXSA9IGFyZ3M7XG5cbiAgICBpc0hhbmRsZXJGZWQgPSB0cnVlO1xuXG4gICAgcmV0dXJuIEZPRGlzcGF0Y2g7XG4gIH07XG5cbiAgRk9Jbml0QmVmb3JlSG9vay51c2UgPSAoLi4uYXJncykgPT4ge1xuICAgIGlmIChpc0hhbmRsZXJGZWQgPT09IGZhbHNlKSB7XG4gICAgICB0aHJvdyBFcnJvcihcIkEgaGFuZGxlciBuZWVkcyB0byBiZSBmZWQgZmlyc3QgYmVmb3JlIGNhbGxpbmcgLnVzZVwiKTtcbiAgICB9XG4gICAgaWYgKGFyZ3MubGVuZ3RoID4gMSkge1xuICAgICAgcHZ0TG9nZ2VyLmxvZ1dhcm5pbmcoXG4gICAgICAgIGBJZ25vcmluZyAybmQgYXJndW1lbnQuIFwidXNlXCIgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBtb3JlIHRoYW4gMSBhcmd1bWVudC5gXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAocHZ0RGlzcGF0Y2hlZCA9PT0gdHJ1ZSkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIFwiVXNpbmcgbWlkZGxld2FyZXMgYWdhaW4gYWZ0ZXIgaGFuZGxlcidzIGludm9jYXRpb24gaXMgbm90IGFsbG93ZWQuXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgbWlkZGxld2FyZSA9IGFyZ3NbMF07XG5cbiAgICBpZiAobWlkZGxld2FyZVtTWU1CT0xfQkVGT1JFSE9PS19NSURETEVXQVJFX0lEXSA9PT0gdHJ1ZSkge1xuICAgICAgc3RhY2tlZEhvb2tzLnB1c2gobWlkZGxld2FyZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBcIlVua25vd24gbWlkZGxld2FyZS4gTWlkZGxld2FyZXMgbXVzdCBleHRlbmQgQmFzZU1pZGRsZXdhcmUuXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIEZPSW5pdEJlZm9yZUhvb2s7XG4gIH07XG5cbiAgRk9Jbml0QmVmb3JlSG9vay5zZXRMb2dnZXIgPSBuZXdMb2dnZXIgPT4ge1xuICAgIHB2dExvZ2dlciA9IG5ld0xvZ2dlcjtcbiAgfTtcblxuICBGT0luaXRCZWZvcmVIb29rLmdldExvZ2dlciA9ICgpID0+IHB2dExvZ2dlcjtcblxuICBGT0Rpc3BhdGNoID0gYXN5bmMgKC4uLmFyZ3MpID0+IHtcbiAgICBsZXQgaG9va0JlZm9yZUNhdGNoaW5nID0ge307XG4gICAgcHZ0RGlzcGF0Y2hlZCA9IHRydWU7XG5cbiAgICB0cnkge1xuICAgICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtc3ludGF4ICovXG4gICAgICBmb3IgKGNvbnN0IGhvb2sgb2Ygc3RhY2tlZEhvb2tzKSB7XG4gICAgICAgIGhvb2tCZWZvcmVDYXRjaGluZyA9IGhvb2s7XG5cbiAgICAgICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWF3YWl0LWluLWxvb3AgKi9cbiAgICAgICAgYXdhaXQgaG9vayguLi5hcmdzKTtcbiAgICAgICAgLy8gY29uc3QgZXh0ZW5zaW9ucyA9IGF3YWl0IGhvb2soLi4uYXJncyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAobWlkZGxld2FyZXNUaHJvdykge1xuICAgICAgY29uc3QgY2F0Y2hIYW5kbGVyVG9Vc2UgPVxuICAgICAgICB0eXBlb2YgaG9va0JlZm9yZUNhdGNoaW5nLnNjcnRPbkNhdGNoID09PSBcImZ1bmN0aW9uXCJcbiAgICAgICAgICA/IChlcnIsIHBhcmFtcykgPT5cbiAgICAgICAgICAgICAgaG9va0JlZm9yZUNhdGNoaW5nLnNjcnRPbkNhdGNoKGUgPT4gb25DYXRjaChlLCBwYXJhbXMpLCBlcnIpXG4gICAgICAgICAgOiAoZXJyLCBwYXJhbXMpID0+IG9uQ2F0Y2goZXJyLCBwYXJhbXMpO1xuICAgICAgaWYgKHNldHRpbmdzLnN0b3BPbkNhdGNoID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybiBjYXRjaEhhbmRsZXJUb1VzZShtaWRkbGV3YXJlc1Rocm93LCB7XG4gICAgICAgICAgZ2V0UGFyYW1zOiAoKSA9PiBhcmdzXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY2F0Y2hIYW5kbGVyVG9Vc2UobWlkZGxld2FyZXNUaHJvdywge1xuICAgICAgICBnZXRQYXJhbXM6ICgpID0+IGFyZ3NcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBoYW5kbGVyQ2FsbFdyYXBwZXIoLi4uYXJncyk7XG4gIH07XG5cbiAgLyogY29weSBwcm9wZXJ0aWVzIG9mIEZPSW5pdEJlZm9yZUhvb2sgdG8gRk9EaXNwYXRjaCAtIHNvIHdlIGNhbiBjaGFpbiAudXNlIGFuZCBldGMgKi9cbiAgT2JqZWN0LmtleXMoRk9Jbml0QmVmb3JlSG9vaykuZm9yRWFjaChtZXRob2QgPT4ge1xuICAgIEZPRGlzcGF0Y2hbbWV0aG9kXSA9IEZPSW5pdEJlZm9yZUhvb2tbbWV0aG9kXTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqXG4gICAqIENPUkUgLSBFTkRcbiAgICpcbiAgICogKi9cblxuICByZXR1cm4gRk9Jbml0QmVmb3JlSG9vaztcbn07XG5cbmV4cG9ydCB7IEJhc2VNaWRkbGV3YXJlLCBCb2R5UGFyc2VyTWlkZGxld2FyZSwgQ3JlYXRlSW5zdGFuY2UgfTtcblxuZXhwb3J0IGRlZmF1bHQgQ3JlYXRlSW5zdGFuY2U7XG4iXX0=
