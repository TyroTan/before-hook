"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.validateHandler = exports.getHandlerArgumentsLength = exports.CreateInstance = exports.BodyParserMiddleware = exports.BaseMiddleware = exports.MIDDLEWARE_CONSTANTS = void 0;

require("source-map-support/register");

const MIDDLEWARE_PREFIX = "BEFORE_HOOK_";
const MIDDLEWARE_CONSTANTS = {
  HTTP_RESPONSE: `${MIDDLEWARE_PREFIX}HTTP_RESPONSE`
};
/* const isAsyncFunction = fn => {
  return fn.constructor.name === "AsyncFunction";
}; */

exports.MIDDLEWARE_CONSTANTS = MIDDLEWARE_CONSTANTS;

const objectAssignIfExists = (...args) => {
  const def = { ...args[1]
  };
  const overrideIfExist = { ...args[2]
  };
  Object.keys(def).forEach(k => {
    if (overrideIfExist[k]) {
      def[k] = overrideIfExist[k];
    }
  });
  return { ...args[0],
    ...def
  };
};

const getHandlerArgumentsLength = handler => {
  let result = -1;

  try {
    if (typeof handler !== "function") throw Error(`Handler must be a function. type '${typeof handler}'`);
    const def = handler.toString();
    const removeCommentsRegex = new RegExp(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm);
    const noSpaceAndComments = def.replace(removeCommentsRegex, "").replace(new RegExp("(\\s|\\n)", "g"), "");
    const commasRegExp = new RegExp(`\\,`, "g");
    const match = noSpaceAndComments.match(commasRegExp);

    if (!match) {
      result = noSpaceAndComments.indexOf("()") > -1 ? 0 : 1;
    } else {
      result = match.length + 1;
    }
  } catch (e) {
    console.error(`__getArgumentsLength__. ${e.message}`);
  }

  return result;
};

exports.getHandlerArgumentsLength = getHandlerArgumentsLength;

const validateHandler = handler => {
  if (typeof handler !== "function") throw TypeError(`Handler must be a function${typeof handler} ${Object.keys(handler).reduce((acc, cur) => `${acc} ${cur}`, "")}`);
  const count = getHandlerArgumentsLength(handler);
  return count >= 0 || count <= 1;
};

exports.validateHandler = validateHandler;

const readError = e => {
  let isMiddlewareHTTPResponse = false;

  try {
    const objError = typeof e.message === "object" ? e.message : JSON.parse(e.message);
    isMiddlewareHTTPResponse = objError.type === MIDDLEWARE_CONSTANTS.HTTP_RESPONSE;
    const {
      responseObject
    } = objError;

    if (typeof responseObject === "undefined") {
      throw Error(`Invalid custom "responseObject"`);
    }

    return {
      e,
      isMiddlewareHTTPResponse,
      responseObject
    };
  } catch (err) {
    return {
      e,
      err,
      errorMessage: `${e.message} - ${err.message}`
    };
  }
};

const MiddlewareHelpersInit = () => {
  const pvtLogger = {
    /* eslint-disable-next-line no-console */
    log: (...args) => args.forEach(l => console.log(l.message || l)),

    /* eslint-disable-next-line no-console */
    logError: (...args) => args.forEach(l => console.error(l.message || l))
  };

  const returnAndSendResponse = obj => {
    let stringErr = "";

    try {
      const errorObj = {
        type: MIDDLEWARE_CONSTANTS.HTTP_RESPONSE,
        responseObject: obj
      };
      stringErr = JSON.stringify({ ...errorObj
      });
    } catch (e) {
      if (pvtLogger && typeof pvtLogger.logError === "function") {
        pvtLogger.logError(e);
      }

      throw e;
    }

    throw Error(stringErr);
  };

  return () => ({
    returnAndSendResponse,
    getLogger: () => pvtLogger
  });
};

const setState = (objs, oldState, state) => {
  const mutatedOldState = oldState;
  const newState = state;
  Object.keys(objs).forEach(key => {
    newState[key] = objs[key];
    mutatedOldState[key] = objs[key];
  });
  return mutatedOldState;
};

const setContext = setState;

const simpleClone = objectToClone =>
/* JSON.parse(JSON.stringify( */
objectToClone;
/* )) */


const clone = simpleClone;

const BaseMiddlewareHandlerInit = handler => {
  const fn = async (event, context) => {
    const pvtEvent = event ? clone(event) : "";
    const pvtContext = context ? clone(context) : "";
    await handler({
      getParams: () => ({
        event: pvtEvent,
        setEvent: objs => setState(objs, event, pvtEvent),
        context: pvtContext,
        setContext: objs => setContext(objs, context, pvtContext)
      }),
      getHelpers: MiddlewareHelpersInit()
    }, {});
    return {
      event: pvtEvent,
      context: pvtContext
    };
  };

  return fn;
};

const BaseMiddleware = ({
  handler,
  configure
} = {}) => {
  if (!(typeof handler === "function")) {
    throw Error(`Custom middlewares must define a "handler"`);
  }

  let pre = async () => {};

  pre = BaseMiddlewareHandlerInit(handler);
  pre.isHookMiddleware = true;

  if (configure && configure.augmentMethods) {
    const {
      augmentMethods = {}
    } = configure;
    const configurableMethods = ["onCatch"];
    configurableMethods.forEach(fnName => {
      const newMethod = augmentMethods[fnName];

      if (typeof newMethod === "function") {
        if (fnName === "onCatch") {
          pre.scrtOnCatch = (oldMethod, e) => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        }
      }
    });
  }

  return pre;
};

exports.BaseMiddleware = BaseMiddleware;

const BodyParserMiddleware = () => {
  return BaseMiddleware({
    handler: async ({
      getParams
    }) => {
      const {
        event,
        setEvent
      } = getParams();

      if (Object.keys({ ...event.body
      }).length) {
        setEvent({
          body: JSON.parse(event.body)
        });
      }
    }
  });
};

exports.BodyParserMiddleware = BodyParserMiddleware;

const CreateInstance = options => {
  let settings = {
    DEBUG: false,
    stopOnCatch: true,
    silent: false
  };
  settings = objectAssignIfExists({}, settings, options);
  let pvtDispatched = false;
  const stackedHooks = [];
  let isHandlerFed = false;

  let handler = async () => {};

  let FOInvokeMiddlewares = async () => {};
  /**
   *
   * CONFIGURABLES - START
   *
   * */


  let pvtLogger = {
    /* eslint-disable-next-line no-console */
    log: (...args) => args.forEach(l => console.log(l.message || l)),

    /* eslint-disable-next-line no-console */
    logError: (...args) => args.forEach(l => console.error(l.message || l)),
    logWarning: (...args) =>
    /* eslint-disable-next-line no-console */
    args.forEach(l => console.error(`WARNING: ${l.message || l}`))
  };

  if (settings.DEBUG !== true || settings.silent === true) {
    pvtLogger.log = () => {};

    pvtLogger.logError = () => {};

    pvtLogger.logWarning = () => {};
  }

  let onCatch = (...args) => {
    const [e] = args;

    if (pvtLogger && typeof pvtLogger.logError === "function") {
      pvtLogger.logError(e);
    }

    const read = readError(e);

    if (read.isMiddlewareHTTPResponse === true) {
      return read.responseObject;
    }

    return {
      statusCode: 500,
      body: `${read.errorMessage}`
    };
  };

  let handlerCallWrapper = (...args) => {
    return handler(...args);
  };
  /**
   *
   * CONFIGURABLES - END
   *
   * */


  const configure = ({
    augmentMethods = {}
  } = {}) => {
    const configurableMethods = ["onCatch", "handlerCallWrapper", "pvtLogger"];
    configurableMethods.forEach(fnName => {
      const newMethod = augmentMethods[fnName];

      if (typeof newMethod === "function") {
        if (fnName === "onCatch") {
          const oldMethod = onCatch;

          onCatch = (arg1, {
            event,
            context
          }) => {
            return newMethod(() => oldMethod(arg1), {
              prevRawMethod: oldMethod,
              arg: arg1,
              event,
              context
            });
          };
        } else if (fnName === "handlerCallWrapper") {
          const oldMethod = handlerCallWrapper;

          handlerCallWrapper = e => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        } else if (fnName === "pvtLogger") {
          const oldMethod = pvtLogger;

          pvtLogger = e => {
            return newMethod(() => oldMethod(e), {
              prevRawMethod: oldMethod,
              arg: e
            });
          };
        }
      }
    });
  };
  /* init configurables */


  if (options && options.configure) {
    configure(options.configure);
  }
  /**
   *
   * CORE - START
   *
   * */

  /** Function Object Init "Before Hook" * */


  const FOInitBeforeHook = (...args) => {
    if (typeof args[0] !== "function") {
      return FOInvokeMiddlewares(...args);
    }

    if (isHandlerFed === false && validateHandler(args[0]) === false) {
      throw Error(`DEPRECATED - Please use the exact argument names of the handler as the following event,context,callback or simply (event, context) => {} or () => {}`);
    }

    if (isHandlerFed === true && args[0].isHookMiddleware !== true) {
      /* then we assume this scenario calls for a new instance */
      return CreateInstance(options)(args[0]);
    }

    [handler] = args;
    isHandlerFed = true;
    return FOInvokeMiddlewares;
  };

  FOInitBeforeHook.use = (...args) => {
    const middleware = args[0];

    if (isHandlerFed === false) {
      throw Error("A handler needs to be fed first before calling .use");
    }

    if (args.length > 1) {
      if (pvtLogger && typeof pvtLogger.logWarning === "function") {
        pvtLogger.logWarning(`Ignoring 2nd argument. "use" method was called with more than 1 argument.`);
      }
    }

    if (pvtDispatched === true) {
      throw Error("Using middlewares again after handler's invocation is not allowed.");
    }

    if (middleware.isHookMiddleware === true) {
      stackedHooks.push(middleware);
    } else {
      throw Error("Unknown middlewares are not yet supported. Please extend `Base` middleware instead.");
    }

    return FOInitBeforeHook;
  };

  FOInitBeforeHook.setLogger = newLogger => {
    pvtLogger = newLogger;
  };

  FOInitBeforeHook.getLogger = () => pvtLogger;

  FOInvokeMiddlewares = async (event, context) => {
    let extendedEvent = event;
    let extendedContext = context;
    let hookBeforeCatching = {};
    pvtDispatched = true;

    try {
      /* eslint-disable-next-line no-restricted-syntax */
      for (const hook of stackedHooks) {
        hookBeforeCatching = hook;
        /* eslint-disable-next-line no-await-in-loop */

        const extensions = await hook(extendedEvent, extendedContext);

        if (extensions.event) {
          extendedEvent = setState(extensions.event, event, extendedEvent);
        }

        if (extensions.context) {
          extendedContext = setState(extensions.context, context, extendedContext);
        }
      }
    } catch (middlewaresThrow) {
      const catchHandlerToUse = typeof hookBeforeCatching.scrtOnCatch === "function" ? (err, eventAndContext) => hookBeforeCatching.scrtOnCatch(e => onCatch(e, eventAndContext), err) : (err, eventAndContext) => onCatch(err, eventAndContext);

      if (settings.stopOnCatch === true) {
        return catchHandlerToUse(middlewaresThrow, {
          event: extendedEvent,
          context: extendedContext
        });
      }

      catchHandlerToUse(middlewaresThrow, {
        event: extendedEvent,
        context: extendedContext
      });
    }

    return handlerCallWrapper(extendedEvent, extendedContext);
  };
  /* copy properties of FOInitBeforeHook to FOInvokeMiddlewares - so we can chain .use and etc */


  Object.keys(FOInitBeforeHook).forEach(method => {
    FOInvokeMiddlewares[method] = FOInitBeforeHook[method];
  });
  /**
   *
   * CORE - END
   *
   * */

  return FOInitBeforeHook;
};

exports.CreateInstance = CreateInstance;
var _default = CreateInstance;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnNvdXJjZS5qcyJdLCJuYW1lcyI6WyJNSURETEVXQVJFX1BSRUZJWCIsIk1JRERMRVdBUkVfQ09OU1RBTlRTIiwiSFRUUF9SRVNQT05TRSIsIm9iamVjdEFzc2lnbklmRXhpc3RzIiwiYXJncyIsImRlZiIsIm92ZXJyaWRlSWZFeGlzdCIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwiayIsImdldEhhbmRsZXJBcmd1bWVudHNMZW5ndGgiLCJoYW5kbGVyIiwicmVzdWx0IiwiRXJyb3IiLCJ0b1N0cmluZyIsInJlbW92ZUNvbW1lbnRzUmVnZXgiLCJSZWdFeHAiLCJub1NwYWNlQW5kQ29tbWVudHMiLCJyZXBsYWNlIiwiY29tbWFzUmVnRXhwIiwibWF0Y2giLCJpbmRleE9mIiwibGVuZ3RoIiwiZSIsImNvbnNvbGUiLCJlcnJvciIsIm1lc3NhZ2UiLCJ2YWxpZGF0ZUhhbmRsZXIiLCJUeXBlRXJyb3IiLCJyZWR1Y2UiLCJhY2MiLCJjdXIiLCJjb3VudCIsInJlYWRFcnJvciIsImlzTWlkZGxld2FyZUhUVFBSZXNwb25zZSIsIm9iakVycm9yIiwiSlNPTiIsInBhcnNlIiwidHlwZSIsInJlc3BvbnNlT2JqZWN0IiwiZXJyIiwiZXJyb3JNZXNzYWdlIiwiTWlkZGxld2FyZUhlbHBlcnNJbml0IiwicHZ0TG9nZ2VyIiwibG9nIiwibCIsImxvZ0Vycm9yIiwicmV0dXJuQW5kU2VuZFJlc3BvbnNlIiwib2JqIiwic3RyaW5nRXJyIiwiZXJyb3JPYmoiLCJzdHJpbmdpZnkiLCJnZXRMb2dnZXIiLCJzZXRTdGF0ZSIsIm9ianMiLCJvbGRTdGF0ZSIsInN0YXRlIiwibXV0YXRlZE9sZFN0YXRlIiwibmV3U3RhdGUiLCJrZXkiLCJzZXRDb250ZXh0Iiwic2ltcGxlQ2xvbmUiLCJvYmplY3RUb0Nsb25lIiwiY2xvbmUiLCJCYXNlTWlkZGxld2FyZUhhbmRsZXJJbml0IiwiZm4iLCJldmVudCIsImNvbnRleHQiLCJwdnRFdmVudCIsInB2dENvbnRleHQiLCJnZXRQYXJhbXMiLCJzZXRFdmVudCIsImdldEhlbHBlcnMiLCJCYXNlTWlkZGxld2FyZSIsImNvbmZpZ3VyZSIsInByZSIsImlzSG9va01pZGRsZXdhcmUiLCJhdWdtZW50TWV0aG9kcyIsImNvbmZpZ3VyYWJsZU1ldGhvZHMiLCJmbk5hbWUiLCJuZXdNZXRob2QiLCJzY3J0T25DYXRjaCIsIm9sZE1ldGhvZCIsInByZXZSYXdNZXRob2QiLCJhcmciLCJCb2R5UGFyc2VyTWlkZGxld2FyZSIsImJvZHkiLCJDcmVhdGVJbnN0YW5jZSIsIm9wdGlvbnMiLCJzZXR0aW5ncyIsIkRFQlVHIiwic3RvcE9uQ2F0Y2giLCJzaWxlbnQiLCJwdnREaXNwYXRjaGVkIiwic3RhY2tlZEhvb2tzIiwiaXNIYW5kbGVyRmVkIiwiRk9JbnZva2VNaWRkbGV3YXJlcyIsImxvZ1dhcm5pbmciLCJvbkNhdGNoIiwicmVhZCIsInN0YXR1c0NvZGUiLCJoYW5kbGVyQ2FsbFdyYXBwZXIiLCJhcmcxIiwiRk9Jbml0QmVmb3JlSG9vayIsInVzZSIsIm1pZGRsZXdhcmUiLCJwdXNoIiwic2V0TG9nZ2VyIiwibmV3TG9nZ2VyIiwiZXh0ZW5kZWRFdmVudCIsImV4dGVuZGVkQ29udGV4dCIsImhvb2tCZWZvcmVDYXRjaGluZyIsImhvb2siLCJleHRlbnNpb25zIiwibWlkZGxld2FyZXNUaHJvdyIsImNhdGNoSGFuZGxlclRvVXNlIiwiZXZlbnRBbmRDb250ZXh0IiwibWV0aG9kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxNQUFNQSxpQkFBaUIsR0FBRyxjQUExQjtBQUNBLE1BQU1DLG9CQUFvQixHQUFHO0FBQzNCQyxFQUFBQSxhQUFhLEVBQUcsR0FBRUYsaUJBQWtCO0FBRFQsQ0FBN0I7QUFJQTs7Ozs7O0FBSUEsTUFBTUcsb0JBQW9CLEdBQUcsQ0FBQyxHQUFHQyxJQUFKLEtBQWE7QUFDeEMsUUFBTUMsR0FBRyxHQUFHLEVBQUUsR0FBR0QsSUFBSSxDQUFDLENBQUQ7QUFBVCxHQUFaO0FBQ0EsUUFBTUUsZUFBZSxHQUFHLEVB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YUFBRCxFQUFnQkMsZUFBaEIsQ0FBekI7QUFDRCxHQTNDRDtBQTZDQTs7O0FBQ0F4RyxFQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWWdHLGdCQUFaLEVBQThCL0YsT0FBOUIsQ0FBc0M2RyxNQUFNLElBQUk7QUFDOUNyQixJQUFBQSxtQkFBbUIsQ0FBQ3FCLE1BQUQsQ0FBbkIsR0FBOEJkLGdCQUFnQixDQUFDYyxNQUFELENBQTlDO0FBQ0QsR0FGRDtBQUlBOzs7Ozs7QUFNQSxTQUFPZCxnQkFBUDtBQUNELENBeE9EOzs7ZUFtUGVoQixjIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgTUlERExFV0FSRV9QUkVGSVggPSBcIkJFRk9SRV9IT09LX1wiO1xuY29uc3QgTUlERExFV0FSRV9DT05TVEFOVFMgPSB7XG4gIEhUVFBfUkVTUE9OU0U6IGAke01JRERMRVdBUkVfUFJFRklYfUhUVFBfUkVTUE9OU0VgXG59O1xuXG4vKiBjb25zdCBpc0FzeW5jRnVuY3Rpb24gPSBmbiA9PiB7XG4gIHJldHVybiBmbi5jb25zdHJ1Y3Rvci5uYW1lID09PSBcIkFzeW5jRnVuY3Rpb25cIjtcbn07ICovXG5cbmNvbnN0IG9iamVjdEFzc2lnbklmRXhpc3RzID0gKC4uLmFyZ3MpID0+IHtcbiAgY29uc3QgZGVmID0geyAuLi5hcmdzWzFdIH07XG4gIGNvbnN0IG92ZXJyaWRlSWZFeGlzdCA9IHsgLi4uYXJnc1syXSB9O1xuICBPYmplY3Qua2V5cyhkZWYpLmZvckVhY2goayA9PiB7XG4gICAgaWYgKG92ZXJyaWRlSWZFeGlzdFtrXSkge1xuICAgICAgZGVmW2tdID0gb3ZlcnJpZGVJZkV4aXN0W2tdO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHsgLi4uYXJnc1swXSwgLi4uZGVmIH07XG59O1xuXG5jb25zdCBnZXRIYW5kbGVyQXJndW1lbnRzTGVuZ3RoID0gaGFuZGxlciA9PiB7XG4gIGxldCByZXN1bHQgPSAtMTtcbiAgdHJ5IHtcbiAgICBpZiAodHlwZW9mIGhhbmRsZXIgIT09IFwiZnVuY3Rpb25cIilcbiAgICAgIHRocm93IEVycm9yKGBIYW5kbGVyIG11c3QgYmUgYSBmdW5jdGlvbi4gdHlwZSAnJHt0eXBlb2YgaGFuZGxlcn0nYCk7XG5cbiAgICBjb25zdCBkZWYgPSBoYW5kbGVyLnRvU3RyaW5nKCk7XG4gICAgY29uc3QgcmVtb3ZlQ29tbWVudHNSZWdleCA9IG5ldyBSZWdFeHAoXG4gICAgICAvXFwvXFwqW1xcc1xcU10qP1xcKlxcL3woW15cXFxcOl18XilcXC9cXC8uKiQvZ21cbiAgICApO1xuICAgIGNvbnN0IG5vU3BhY2VBbmRDb21tZW50cyA9IGRlZlxuICAgICAgLnJlcGxhY2UocmVtb3ZlQ29tbWVudHNSZWdleCwgXCJcIilcbiAgICAgIC5yZXBsYWNlKG5ldyBSZWdFeHAoXCIoXFxcXHN8XFxcXG4pXCIsIFwiZ1wiKSwgXCJcIik7XG5cbiAgICBjb25zdCBjb21tYXNSZWdFeHAgPSBuZXcgUmVnRXhwKGBcXFxcLGAsIFwiZ1wiKTtcblxuICAgIGNvbnN0IG1hdGNoID0gbm9TcGFjZUFuZENvbW1lbnRzLm1hdGNoKGNvbW1hc1JlZ0V4cCk7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgcmVzdWx0ID0gbm9TcGFjZUFuZENvbW1lbnRzLmluZGV4T2YoXCIoKVwiKSA+IC0xID8gMCA6IDE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdCA9IG1hdGNoLmxlbmd0aCArIDE7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5lcnJvcihgX19nZXRBcmd1bWVudHNMZW5ndGhfXy4gJHtlLm1lc3NhZ2V9YCk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgdmFsaWRhdGVIYW5kbGVyID0gaGFuZGxlciA9PiB7XG4gIGlmICh0eXBlb2YgaGFuZGxlciAhPT0gXCJmdW5jdGlvblwiKVxuICAgIHRocm93IFR5cGVFcnJvcihcbiAgICAgIGBIYW5kbGVyIG11c3QgYmUgYSBmdW5jdGlvbiR7dHlwZW9mIGhhbmRsZXJ9ICR7T2JqZWN0LmtleXMoXG4gICAgICAgIGhhbmRsZXJcbiAgICAgICkucmVkdWNlKChhY2MsIGN1cikgPT4gYCR7YWNjfSAke2N1cn1gLCBcIlwiKX1gXG4gICAgKTtcblxuICBjb25zdCBjb3VudCA9IGdldEhhbmRsZXJBcmd1bWVudHNMZW5ndGgoaGFuZGxlcik7XG4gIHJldHVybiBjb3VudCA+PSAwIHx8IGNvdW50IDw9IDE7XG59O1xuXG5jb25zdCByZWFkRXJyb3IgPSBlID0+IHtcbiAgbGV0IGlzTWlkZGxld2FyZUhUVFBSZXNwb25zZSA9IGZhbHNlO1xuICB0cnkge1xuICAgIGNvbnN0IG9iakVycm9yID1cbiAgICAgIHR5cGVvZiBlLm1lc3NhZ2UgPT09IFwib2JqZWN0XCIgPyBlLm1lc3NhZ2UgOiBKU09OLnBhcnNlKGUubWVzc2FnZSk7XG5cbiAgICBpc01pZGRsZXdhcmVIVFRQUmVzcG9uc2UgPVxuICAgICAgb2JqRXJyb3IudHlwZSA9PT0gTUlERExFV0FSRV9DT05TVEFOVFMuSFRUUF9SRVNQT05TRTtcblxuICAgIGNvbnN0IHsgcmVzcG9uc2VPYmplY3QgfSA9IG9iakVycm9yO1xuICAgIGlmICh0eXBlb2YgcmVzcG9uc2VPYmplY3QgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHRocm93IEVycm9yKGBJbnZhbGlkIGN1c3RvbSBcInJlc3BvbnNlT2JqZWN0XCJgKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZSxcbiAgICAgIGlzTWlkZGxld2FyZUhUVFBSZXNwb25zZSxcbiAgICAgIHJlc3BvbnNlT2JqZWN0XG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmV0dXJuIHsgZSwgZXJyLCBlcnJvck1lc3NhZ2U6IGAke2UubWVzc2FnZX0gLSAke2Vyci5tZXNzYWdlfWAgfTtcbiAgfVxufTtcblxuY29uc3QgTWlkZGxld2FyZUhlbHBlcnNJbml0ID0gKCkgPT4ge1xuICBjb25zdCBwdnRMb2dnZXIgPSB7XG4gICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGUgKi9cbiAgICBsb2c6ICguLi5hcmdzKSA9PiBhcmdzLmZvckVhY2gobCA9PiBjb25zb2xlLmxvZyhsLm1lc3NhZ2UgfHwgbCkpLFxuXG4gICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGUgKi9cbiAgICBsb2dFcnJvcjogKC4uLmFyZ3MpID0+IGFyZ3MuZm9yRWFjaChsID0+IGNvbnNvbGUuZXJyb3IobC5tZXNzYWdlIHx8IGwpKVxuICB9O1xuXG4gIGNvbnN0IHJldHVybkFuZFNlbmRSZXNwb25zZSA9IG9iaiA9PiB7XG4gICAgbGV0IHN0cmluZ0VyciA9IFwiXCI7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGVycm9yT2JqID0ge1xuICAgICAgICB0eXBlOiBNSURETEVXQVJFX0NPTlNUQU5UUy5IVFRQX1JFU1BPTlNFLFxuICAgICAgICByZXNwb25zZU9iamVjdDogb2JqXG4gICAgICB9O1xuICAgICAgc3RyaW5nRXJyID0gSlNPTi5zdHJpbmdpZnkoeyAuLi5lcnJvck9iaiB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAocHZ0TG9nZ2VyICYmIHR5cGVvZiBwdnRMb2dnZXIubG9nRXJyb3IgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBwdnRMb2dnZXIubG9nRXJyb3IoZSk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cblxuICAgIHRocm93IEVycm9yKHN0cmluZ0Vycik7XG4gIH07XG5cbiAgcmV0dXJuICgpID0+ICh7XG4gICAgcmV0dXJuQW5kU2VuZFJlc3BvbnNlLFxuICAgIGdldExvZ2dlcjogKCkgPT4gcHZ0TG9nZ2VyXG4gIH0pO1xufTtcblxuY29uc3Qgc2V0U3RhdGUgPSAob2Jqcywgb2xkU3RhdGUsIHN0YXRlKSA9PiB7XG4gIGNvbnN0IG11dGF0ZWRPbGRTdGF0ZSA9IG9sZFN0YXRlO1xuICBjb25zdCBuZXdTdGF0ZSA9IHN0YXRlO1xuXG4gIE9iamVjdC5rZXlzKG9ianMpLmZvckVhY2goa2V5ID0+IHtcbiAgICBuZXdTdGF0ZVtrZXldID0gb2Jqc1trZXldO1xuICAgIG11dGF0ZWRPbGRTdGF0ZVtrZXldID0gb2Jqc1trZXldO1xuICB9KTtcblxuICByZXR1cm4gbXV0YXRlZE9sZFN0YXRlO1xufTtcbmNvbnN0IHNldENvbnRleHQgPSBzZXRTdGF0ZTtcbmNvbnN0IHNpbXBsZUNsb25lID0gb2JqZWN0VG9DbG9uZSA9PlxuICAvKiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KCAqLyBvYmplY3RUb0Nsb25lOyAvKiApKSAqL1xuY29uc3QgY2xvbmUgPSBzaW1wbGVDbG9uZTtcblxuY29uc3QgQmFzZU1pZGRsZXdhcmVIYW5kbGVySW5pdCA9IGhhbmRsZXIgPT4ge1xuICBjb25zdCBmbiA9IGFzeW5jIChldmVudCwgY29udGV4dCkgPT4ge1xuICAgIGNvbnN0IHB2dEV2ZW50ID0gZXZlbnQgPyBjbG9uZShldmVudCkgOiBcIlwiO1xuICAgIGNvbnN0IHB2dENvbnRleHQgPSBjb250ZXh0ID8gY2xvbmUoY29udGV4dCkgOiBcIlwiO1xuXG4gICAgYXdhaXQgaGFuZGxlcihcbiAgICAgIHtcbiAgICAgICAgZ2V0UGFyYW1zOiAoKSA9PiAoe1xuICAgICAgICAgIGV2ZW50OiBwdnRFdmVudCxcbiAgICAgICAgICBzZXRFdmVudDogb2JqcyA9PiBzZXRTdGF0ZShvYmpzLCBldmVudCwgcHZ0RXZlbnQpLFxuICAgICAgICAgIGNvbnRleHQ6IHB2dENvbnRleHQsXG4gICAgICAgICAgc2V0Q29udGV4dDogb2JqcyA9PiBzZXRDb250ZXh0KG9ianMsIGNvbnRleHQsIHB2dENvbnRleHQpXG4gICAgICAgIH0pLFxuICAgICAgICBnZXRIZWxwZXJzOiBNaWRkbGV3YXJlSGVscGVyc0luaXQoKVxuICAgICAgfSxcbiAgICAgIHt9XG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBldmVudDogcHZ0RXZlbnQsXG4gICAgICBjb250ZXh0OiBwdnRDb250ZXh0XG4gICAgfTtcbiAgfTtcblxuICByZXR1cm4gZm47XG59O1xuXG5jb25zdCBCYXNlTWlkZGxld2FyZSA9ICh7IGhhbmRsZXIsIGNvbmZpZ3VyZSB9ID0ge30pID0+IHtcbiAgaWYgKCEodHlwZW9mIGhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikpIHtcbiAgICB0aHJvdyBFcnJvcihgQ3VzdG9tIG1pZGRsZXdhcmVzIG11c3QgZGVmaW5lIGEgXCJoYW5kbGVyXCJgKTtcbiAgfVxuXG4gIGxldCBwcmUgPSBhc3luYyAoKSA9PiB7fTtcbiAgcHJlID0gQmFzZU1pZGRsZXdhcmVIYW5kbGVySW5pdChoYW5kbGVyKTtcblxuICBwcmUuaXNIb29rTWlkZGxld2FyZSA9IHRydWU7XG5cbiAgaWYgKGNvbmZpZ3VyZSAmJiBjb25maWd1cmUuYXVnbWVudE1ldGhvZHMpIHtcbiAgICBjb25zdCB7IGF1Z21lbnRNZXRob2RzID0ge30gfSA9IGNvbmZpZ3VyZTtcbiAgICBjb25zdCBjb25maWd1cmFibGVNZXRob2RzID0gW1wib25DYXRjaFwiXTtcblxuICAgIGNvbmZpZ3VyYWJsZU1ldGhvZHMuZm9yRWFjaChmbk5hbWUgPT4ge1xuICAgICAgY29uc3QgbmV3TWV0aG9kID0gYXVnbWVudE1ldGhvZHNbZm5OYW1lXTtcblxuICAgICAgaWYgKHR5cGVvZiBuZXdNZXRob2QgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBpZiAoZm5OYW1lID09PSBcIm9uQ2F0Y2hcIikge1xuICAgICAgICAgIHByZS5zY3J0T25DYXRjaCA9IChvbGRNZXRob2QsIGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGUpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcHJlO1xufTtcblxuY29uc3QgQm9keVBhcnNlck1pZGRsZXdhcmUgPSAoKSA9PiB7XG4gIHJldHVybiBCYXNlTWlkZGxld2FyZSh7XG4gICAgaGFuZGxlcjogYXN5bmMgKHsgZ2V0UGFyYW1zIH0pID0+IHtcbiAgICAgIGNvbnN0IHsgZXZlbnQsIHNldEV2ZW50IH0gPSBnZXRQYXJhbXMoKTtcbiAgICAgIGlmIChPYmplY3Qua2V5cyh7IC4uLmV2ZW50LmJvZHkgfSkubGVuZ3RoKSB7XG4gICAgICAgIHNldEV2ZW50KHsgYm9keTogSlNPTi5wYXJzZShldmVudC5ib2R5KSB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufTtcblxuY29uc3QgQ3JlYXRlSW5zdGFuY2UgPSBvcHRpb25zID0+IHtcbiAgbGV0IHNldHRpbmdzID0ge1xuICAgIERFQlVHOiBmYWxzZSxcbiAgICBzdG9wT25DYXRjaDogdHJ1ZSxcbiAgICBzaWxlbnQ6IGZhbHNlXG4gIH07XG5cbiAgc2V0dGluZ3MgPSBvYmplY3RBc3NpZ25JZkV4aXN0cyh7fSwgc2V0dGluZ3MsIG9wdGlvbnMpO1xuXG4gIGxldCBwdnREaXNwYXRjaGVkID0gZmFsc2U7XG4gIGNvbnN0IHN0YWNrZWRIb29rcyA9IFtdO1xuICBsZXQgaXNIYW5kbGVyRmVkID0gZmFsc2U7XG5cbiAgbGV0IGhhbmRsZXIgPSBhc3luYyAoKSA9PiB7fTtcbiAgbGV0IEZPSW52b2tlTWlkZGxld2FyZXMgPSBhc3luYyAoKSA9PiB7fTtcblxuICAvKipcbiAgICpcbiAgICogQ09ORklHVVJBQkxFUyAtIFNUQVJUXG4gICAqXG4gICAqICovXG5cbiAgbGV0IHB2dExvZ2dlciA9IHtcbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZzogKC4uLmFyZ3MpID0+IGFyZ3MuZm9yRWFjaChsID0+IGNvbnNvbGUubG9nKGwubWVzc2FnZSB8fCBsKSksXG5cbiAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgIGxvZ0Vycm9yOiAoLi4uYXJncykgPT4gYXJncy5mb3JFYWNoKGwgPT4gY29uc29sZS5lcnJvcihsLm1lc3NhZ2UgfHwgbCkpLFxuXG4gICAgbG9nV2FybmluZzogKC4uLmFyZ3MpID0+XG4gICAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSAqL1xuICAgICAgYXJncy5mb3JFYWNoKGwgPT4gY29uc29sZS5lcnJvcihgV0FSTklORzogJHtsLm1lc3NhZ2UgfHwgbH1gKSlcbiAgfTtcblxuICBpZiAoc2V0dGluZ3MuREVCVUcgIT09IHRydWUgfHwgc2V0dGluZ3Muc2lsZW50ID09PSB0cnVlKSB7XG4gICAgcHZ0TG9nZ2VyLmxvZyA9ICgpID0+IHt9O1xuICAgIHB2dExvZ2dlci5sb2dFcnJvciA9ICgpID0+IHt9O1xuICAgIHB2dExvZ2dlci5sb2dXYXJuaW5nID0gKCkgPT4ge307XG4gIH1cblxuICBsZXQgb25DYXRjaCA9ICguLi5hcmdzKSA9PiB7XG4gICAgY29uc3QgW2VdID0gYXJncztcblxuICAgIGlmIChwdnRMb2dnZXIgJiYgdHlwZW9mIHB2dExvZ2dlci5sb2dFcnJvciA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBwdnRMb2dnZXIubG9nRXJyb3IoZSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVhZCA9IHJlYWRFcnJvcihlKTtcbiAgICBpZiAocmVhZC5pc01pZGRsZXdhcmVIVFRQUmVzcG9uc2UgPT09IHRydWUpIHtcbiAgICAgIHJldHVybiByZWFkLnJlc3BvbnNlT2JqZWN0O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBib2R5OiBgJHtyZWFkLmVycm9yTWVzc2FnZX1gXG4gICAgfTtcbiAgfTtcblxuICBsZXQgaGFuZGxlckNhbGxXcmFwcGVyID0gKC4uLmFyZ3MpID0+IHtcbiAgICByZXR1cm4gaGFuZGxlciguLi5hcmdzKTtcbiAgfTtcblxuICAvKipcbiAgICpcbiAgICogQ09ORklHVVJBQkxFUyAtIEVORFxuICAgKlxuICAgKiAqL1xuXG4gIGNvbnN0IGNvbmZpZ3VyZSA9ICh7IGF1Z21lbnRNZXRob2RzID0ge30gfSA9IHt9KSA9PiB7XG4gICAgY29uc3QgY29uZmlndXJhYmxlTWV0aG9kcyA9IFtcIm9uQ2F0Y2hcIiwgXCJoYW5kbGVyQ2FsbFdyYXBwZXJcIiwgXCJwdnRMb2dnZXJcIl07XG5cbiAgICBjb25maWd1cmFibGVNZXRob2RzLmZvckVhY2goZm5OYW1lID0+IHtcbiAgICAgIGNvbnN0IG5ld01ldGhvZCA9IGF1Z21lbnRNZXRob2RzW2ZuTmFtZV07XG4gICAgICBpZiAodHlwZW9mIG5ld01ldGhvZCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGlmIChmbk5hbWUgPT09IFwib25DYXRjaFwiKSB7XG4gICAgICAgICAgY29uc3Qgb2xkTWV0aG9kID0gb25DYXRjaDtcbiAgICAgICAgICBvbkNhdGNoID0gKGFyZzEsIHsgZXZlbnQsIGNvbnRleHQgfSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ld01ldGhvZCgoKSA9PiBvbGRNZXRob2QoYXJnMSksIHtcbiAgICAgICAgICAgICAgcHJldlJhd01ldGhvZDogb2xkTWV0aG9kLFxuICAgICAgICAgICAgICBhcmc6IGFyZzEsXG4gICAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgICBjb250ZXh0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKGZuTmFtZSA9PT0gXCJoYW5kbGVyQ2FsbFdyYXBwZXJcIikge1xuICAgICAgICAgIGNvbnN0IG9sZE1ldGhvZCA9IGhhbmRsZXJDYWxsV3JhcHBlcjtcbiAgICAgICAgICBoYW5kbGVyQ2FsbFdyYXBwZXIgPSBlID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGUpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKGZuTmFtZSA9PT0gXCJwdnRMb2dnZXJcIikge1xuICAgICAgICAgIGNvbnN0IG9sZE1ldGhvZCA9IHB2dExvZ2dlcjtcbiAgICAgICAgICBwdnRMb2dnZXIgPSBlID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXdNZXRob2QoKCkgPT4gb2xkTWV0aG9kKGUpLCB7XG4gICAgICAgICAgICAgIHByZXZSYXdNZXRob2Q6IG9sZE1ldGhvZCxcbiAgICAgICAgICAgICAgYXJnOiBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgLyogaW5pdCBjb25maWd1cmFibGVzICovXG4gIGlmIChvcHRpb25zICYmIG9wdGlvbnMuY29uZmlndXJlKSB7XG4gICAgY29uZmlndXJlKG9wdGlvbnMuY29uZmlndXJlKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBDT1JFIC0gU1RBUlRcbiAgICpcbiAgICogKi9cblxuICAvKiogRnVuY3Rpb24gT2JqZWN0IEluaXQgXCJCZWZvcmUgSG9va1wiICogKi9cbiAgY29uc3QgRk9Jbml0QmVmb3JlSG9vayA9ICguLi5hcmdzKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBhcmdzWzBdICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHJldHVybiBGT0ludm9rZU1pZGRsZXdhcmVzKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIGlmIChpc0hhbmRsZXJGZWQgPT09IGZhbHNlICYmIHZhbGlkYXRlSGFuZGxlcihhcmdzWzBdKSA9PT0gZmFsc2UpIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBgREVQUkVDQVRFRCAtIFBsZWFzZSB1c2UgdGhlIGV4YWN0IGFyZ3VtZW50IG5hbWVzIG9mIHRoZSBoYW5kbGVyIGFzIHRoZSBmb2xsb3dpbmcgZXZlbnQsY29udGV4dCxjYWxsYmFjayBvciBzaW1wbHkgKGV2ZW50LCBjb250ZXh0KSA9PiB7fSBvciAoKSA9PiB7fWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGlzSGFuZGxlckZlZCA9PT0gdHJ1ZSAmJiBhcmdzWzBdLmlzSG9va01pZGRsZXdhcmUgIT09IHRydWUpIHtcbiAgICAgIC8qIHRoZW4gd2UgYXNzdW1lIHRoaXMgc2NlbmFyaW8gY2FsbHMgZm9yIGEgbmV3IGluc3RhbmNlICovXG4gICAgICByZXR1cm4gQ3JlYXRlSW5zdGFuY2Uob3B0aW9ucykoYXJnc1swXSk7XG4gICAgfVxuXG4gICAgW2hhbmRsZXJdID0gYXJncztcblxuICAgIGlzSGFuZGxlckZlZCA9IHRydWU7XG5cbiAgICByZXR1cm4gRk9JbnZva2VNaWRkbGV3YXJlcztcbiAgfTtcblxuICBGT0luaXRCZWZvcmVIb29rLnVzZSA9ICguLi5hcmdzKSA9PiB7XG4gICAgY29uc3QgbWlkZGxld2FyZSA9IGFyZ3NbMF07XG4gICAgaWYgKGlzSGFuZGxlckZlZCA9PT0gZmFsc2UpIHtcbiAgICAgIHRocm93IEVycm9yKFwiQSBoYW5kbGVyIG5lZWRzIHRvIGJlIGZlZCBmaXJzdCBiZWZvcmUgY2FsbGluZyAudXNlXCIpO1xuICAgIH1cbiAgICBpZiAoYXJncy5sZW5ndGggPiAxKSB7XG4gICAgICBpZiAocHZ0TG9nZ2VyICYmIHR5cGVvZiBwdnRMb2dnZXIubG9nV2FybmluZyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIHB2dExvZ2dlci5sb2dXYXJuaW5nKFxuICAgICAgICAgIGBJZ25vcmluZyAybmQgYXJndW1lbnQuIFwidXNlXCIgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBtb3JlIHRoYW4gMSBhcmd1bWVudC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChwdnREaXNwYXRjaGVkID09PSB0cnVlKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgXCJVc2luZyBtaWRkbGV3YXJlcyBhZ2FpbiBhZnRlciBoYW5kbGVyJ3MgaW52b2NhdGlvbiBpcyBub3QgYWxsb3dlZC5cIlxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAobWlkZGxld2FyZS5pc0hvb2tNaWRkbGV3YXJlID09PSB0cnVlKSB7XG4gICAgICBzdGFja2VkSG9va3MucHVzaChtaWRkbGV3YXJlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIFwiVW5rbm93biBtaWRkbGV3YXJlcyBhcmUgbm90IHlldCBzdXBwb3J0ZWQuIFBsZWFzZSBleHRlbmQgYEJhc2VgIG1pZGRsZXdhcmUgaW5zdGVhZC5cIlxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gRk9Jbml0QmVmb3JlSG9vaztcbiAgfTtcblxuICBGT0luaXRCZWZvcmVIb29rLnNldExvZ2dlciA9IG5ld0xvZ2dlciA9PiB7XG4gICAgcHZ0TG9nZ2VyID0gbmV3TG9nZ2VyO1xuICB9O1xuXG4gIEZPSW5pdEJlZm9yZUhvb2suZ2V0TG9nZ2VyID0gKCkgPT4gcHZ0TG9nZ2VyO1xuXG4gIEZPSW52b2tlTWlkZGxld2FyZXMgPSBhc3luYyAoZXZlbnQsIGNvbnRleHQpID0+IHtcbiAgICBsZXQgZXh0ZW5kZWRFdmVudCA9IGV2ZW50O1xuICAgIGxldCBleHRlbmRlZENvbnRleHQgPSBjb250ZXh0O1xuICAgIGxldCBob29rQmVmb3JlQ2F0Y2hpbmcgPSB7fTtcbiAgICBwdnREaXNwYXRjaGVkID0gdHJ1ZTtcblxuICAgIHRyeSB7XG4gICAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1zeW50YXggKi9cbiAgICAgIGZvciAoY29uc3QgaG9vayBvZiBzdGFja2VkSG9va3MpIHtcbiAgICAgICAgaG9va0JlZm9yZUNhdGNoaW5nID0gaG9vaztcbiAgICAgICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWF3YWl0LWluLWxvb3AgKi9cbiAgICAgICAgY29uc3QgZXh0ZW5zaW9ucyA9IGF3YWl0IGhvb2soZXh0ZW5kZWRFdmVudCwgZXh0ZW5kZWRDb250ZXh0KTtcblxuICAgICAgICBpZiAoZXh0ZW5zaW9ucy5ldmVudCkge1xuICAgICAgICAgIGV4dGVuZGVkRXZlbnQgPSBzZXRTdGF0ZShleHRlbnNpb25zLmV2ZW50LCBldmVudCwgZXh0ZW5kZWRFdmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXh0ZW5zaW9ucy5jb250ZXh0KSB7XG4gICAgICAgICAgZXh0ZW5kZWRDb250ZXh0ID0gc2V0U3RhdGUoZXh0ZW5zaW9ucy5jb250ZXh0LCBjb250ZXh0LCBleHRlbmRlZENvbnRleHQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAobWlkZGxld2FyZXNUaHJvdykge1xuICAgICAgY29uc3QgY2F0Y2hIYW5kbGVyVG9Vc2UgPVxuICAgICAgICB0eXBlb2YgaG9va0JlZm9yZUNhdGNoaW5nLnNjcnRPbkNhdGNoID09PSBcImZ1bmN0aW9uXCJcbiAgICAgICAgICA/IChlcnIsIGV2ZW50QW5kQ29udGV4dCkgPT5cbiAgICAgICAgICAgICAgaG9va0JlZm9yZUNhdGNoaW5nLnNjcnRPbkNhdGNoKFxuICAgICAgICAgICAgICAgIGUgPT4gb25DYXRjaChlLCBldmVudEFuZENvbnRleHQpLFxuICAgICAgICAgICAgICAgIGVyclxuICAgICAgICAgICAgICApXG4gICAgICAgICAgOiAoZXJyLCBldmVudEFuZENvbnRleHQpID0+IG9uQ2F0Y2goZXJyLCBldmVudEFuZENvbnRleHQpO1xuICAgICAgaWYgKHNldHRpbmdzLnN0b3BPbkNhdGNoID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybiBjYXRjaEhhbmRsZXJUb1VzZShtaWRkbGV3YXJlc1Rocm93LCB7XG4gICAgICAgICAgZXZlbnQ6IGV4dGVuZGVkRXZlbnQsXG4gICAgICAgICAgY29udGV4dDogZXh0ZW5kZWRDb250ZXh0XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY2F0Y2hIYW5kbGVyVG9Vc2UobWlkZGxld2FyZXNUaHJvdywge1xuICAgICAgICBldmVudDogZXh0ZW5kZWRFdmVudCxcbiAgICAgICAgY29udGV4dDogZXh0ZW5kZWRDb250ZXh0XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gaGFuZGxlckNhbGxXcmFwcGVyKGV4dGVuZGVkRXZlbnQsIGV4dGVuZGVkQ29udGV4dCk7XG4gIH07XG5cbiAgLyogY29weSBwcm9wZXJ0aWVzIG9mIEZPSW5pdEJlZm9yZUhvb2sgdG8gRk9JbnZva2VNaWRkbGV3YXJlcyAtIHNvIHdlIGNhbiBjaGFpbiAudXNlIGFuZCBldGMgKi9cbiAgT2JqZWN0LmtleXMoRk9Jbml0QmVmb3JlSG9vaykuZm9yRWFjaChtZXRob2QgPT4ge1xuICAgIEZPSW52b2tlTWlkZGxld2FyZXNbbWV0aG9kXSA9IEZPSW5pdEJlZm9yZUhvb2tbbWV0aG9kXTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqXG4gICAqIENPUkUgLSBFTkRcbiAgICpcbiAgICogKi9cblxuICByZXR1cm4gRk9Jbml0QmVmb3JlSG9vaztcbn07XG5cbmV4cG9ydCB7XG4gIE1JRERMRVdBUkVfQ09OU1RBTlRTLFxuICBCYXNlTWlkZGxld2FyZSxcbiAgQm9keVBhcnNlck1pZGRsZXdhcmUsXG4gIENyZWF0ZUluc3RhbmNlLFxuICBnZXRIYW5kbGVyQXJndW1lbnRzTGVuZ3RoLFxuICB2YWxpZGF0ZUhhbmRsZXJcbn07XG5cbmV4cG9ydCBkZWZhdWx0IENyZWF0ZUluc3RhbmNlO1xuIl19
